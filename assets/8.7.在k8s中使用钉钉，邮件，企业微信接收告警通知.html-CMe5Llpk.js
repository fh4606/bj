import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,o as a,d as e}from"./app-CdRwZrpj.js";const i="/assets/2023-10-28_210251_3345940.5521683434218457-DZVE8fDg.png",l="/assets/2023-10-28_202232_3157980.3417943973584434-fzbfidHN.png",p={},t=e(`<h1 id="一、环境" tabindex="-1"><a class="header-anchor" href="#一、环境"><span>一、环境</span></a></h1><table id="01409c3a" class="ne-table" style="table-layout:fixed;border-collapse:collapse;border:1px solid #d9d9d9;width:748px;"><tbody><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="u6c805b9b" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">主机名</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="uc1408c31" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">IP地址</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u44729fd3" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">系统</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ud5e55011" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">说明</span></p></td></tr><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="ufbe8423e" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">k8s</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u8fa64da4" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">192.168.11.65</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="uda9039b8" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">Ubuntu 20.04</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ud3d11ee4" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">k8s版本：v1.23.10 单机版本</span></p></td></tr></tbody></table><h2 id="_1、环境准备" tabindex="-1"><a class="header-anchor" href="#_1、环境准备"><span>1、环境准备</span></a></h2><p>kube-prometheus-stack工具集安装的prometheus</p><h2 id="_2、配置端口转发" tabindex="-1"><a class="header-anchor" href="#_2、配置端口转发"><span>2、配置端口转发</span></a></h2><p>使alertmanager的端口能外部访问</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl port-forward --address=0.0.0.0 svc/prometheus-kube-prometheus-alertmanager -n monitoring 9093:9093 &amp;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h1 id="二、告警通知" tabindex="-1"><a class="header-anchor" href="#二、告警通知"><span>二、告警通知</span></a></h1><p>因为kube-prometheus-stack的工具集已经带alertmanger的配置</p><h2 id="_1、配置邮件告警" tabindex="-1"><a class="header-anchor" href="#_1、配置邮件告警"><span>1、配置邮件告警</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim kube-prometheus-stack/values.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>    global:</span></span>
<span class="line"><span>      #163服务器</span></span>
<span class="line"><span>      smtp_smarthost: &#39;smtp.163.com:465&#39;</span></span>
<span class="line"><span>      #发邮件的邮箱</span></span>
<span class="line"><span>      smtp_from: &#39;cdring@163.com&#39;</span></span>
<span class="line"><span>      #发邮件的邮箱用户名，也就是你的邮箱　　　　　</span></span>
<span class="line"><span>      smtp_auth_username: &#39;cdring@163.com&#39;</span></span>
<span class="line"><span>      #发邮件的邮箱密码</span></span>
<span class="line"><span>      smtp_auth_password: &#39;your-password&#39;</span></span>
<span class="line"><span>      #tls验证配置，false为关闭</span></span>
<span class="line"><span>      smtp_require_tls: false</span></span>
<span class="line"><span>      </span></span>
<span class="line"><span>      </span></span>
<span class="line"><span>    route:</span></span>
<span class="line"><span>      # 全局报警组，这个参数是必选的，和下面报警组名要相同</span></span>
<span class="line"><span>      receiver: &#39;email&#39;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    receivers:</span></span>
<span class="line"><span>    - name: &#39;email&#39;</span></span>
<span class="line"><span>      #接收报警信息的邮箱</span></span>
<span class="line"><span>      email_configs:</span></span>
<span class="line"><span>      - to: &#39;cdring@163.com&#39;</span></span>
<span class="line"><span>        #当告警恢复后也发通知</span></span>
<span class="line"><span>        send_resolved: true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>具体配置如下图：</p><h3 id="更新配置" tabindex="-1"><a class="header-anchor" href="#更新配置"><span>更新配置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>helm upgrade  -n monitoring --create-namespace prometheus kube-prometheus-stack</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>检查</p><p><a href="http://192.168.11.65:9093/#/status" target="_blank" rel="noopener noreferrer">http://192.168.11.65:9093/#/status</a></p><h3 id="手动测试alertmanager接口" tabindex="-1"><a class="header-anchor" href="#手动测试alertmanager接口"><span>手动测试alertmanager接口</span></a></h3><p>需要把9090端口暴露出来，当然通过查看svc的集群ip也是可以的</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#!/usr/bin/env bash</span></span>
<span class="line"><span>alerts1=&#39;[</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    &quot;labels&quot;: {</span></span>
<span class="line"><span>       &quot;alertname&quot;: &quot;DiskRunningFull&quot;,</span></span>
<span class="line"><span>       &quot;dev&quot;: &quot;sda1&quot;,</span></span>
<span class="line"><span>       &quot;instance&quot;: &quot;example1&quot;,</span></span>
<span class="line"><span>       &quot;severity&quot;: &quot;critical&quot;  </span></span>
<span class="line"><span>     },</span></span>
<span class="line"><span>     &quot;annotations&quot;: {</span></span>
<span class="line"><span>        &quot;description&quot;: &quot;The disk sda1 is running full&quot;,</span></span>
<span class="line"><span>        &quot;summary&quot;: &quot;please check the instance example1&quot;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>]&#39;</span></span>
<span class="line"><span>curl -XPOST -d&quot;$alerts1&quot; http://localhost:9093/api/v1/alerts</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>检查</p><p><a href="http://192.168.11.65:9093/#/alerts" target="_blank" rel="noopener noreferrer">http://192.168.11.65:9093/#/alerts</a></p><h3 id="检查alertmanager日志" tabindex="-1"><a class="header-anchor" href="#检查alertmanager日志"><span>检查alertmanager日志</span></a></h3><p>当收不到告警信息，我们需要检查日志</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl --tail 10 alertmanager-prometheus-kube-prometheus-alertmanager-0 -n monitoring</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_2、配置钉钉告警" tabindex="-1"><a class="header-anchor" href="#_2、配置钉钉告警"><span>2、配置钉钉告警</span></a></h2><h3 id="安装prometheus-webhook-dingtalk" tabindex="-1"><a class="header-anchor" href="#安装prometheus-webhook-dingtalk"><span>安装prometheus-webhook-dingtalk</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt; prometheus-webhook-dingtalk.yaml &lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>---</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: ConfigMap</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: dingtalk-config</span></span>
<span class="line"><span>  namespace: monitoring</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    app: dingtalk-config</span></span>
<span class="line"><span>data:</span></span>
<span class="line"><span>  config.yml: |</span></span>
<span class="line"><span>    #templates:</span></span>
<span class="line"><span>    #  - /etc/prometheus-webhook-dingtalk/templates/default.tmpl</span></span>
<span class="line"><span>    targets: </span></span>
<span class="line"><span>      webhook1:</span></span>
<span class="line"><span>        url: https://oapi.dingtalk.com/robot/send?access_token=自己的token</span></span>
<span class="line"><span>        secret: 自己的签名秘钥</span></span>
<span class="line"><span>        #message:</span></span>
<span class="line"><span>        #  title: &#39;{{ template &quot;ding.link.title&quot; . }}&#39;</span></span>
<span class="line"><span>        #  text: &#39;{{ template &quot;ding.link.content&quot; . }}&#39;</span></span>
<span class="line"><span>---</span></span>
<span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: Deployment</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    app: prometheus-webhook-dingtalk</span></span>
<span class="line"><span>  name: prometheus-webhook-dingtalk</span></span>
<span class="line"><span>  namespace: monitoring</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  replicas: 1</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: prometheus-webhook-dingtalk</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: prometheus-webhook-dingtalk</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: prometheus-webhook-dingtalk</span></span>
<span class="line"><span>        image: timonwong/prometheus-webhook-dingtalk:v2.1.0</span></span>
<span class="line"><span>        imagePullPolicy: IfNotPresent</span></span>
<span class="line"><span>        args:</span></span>
<span class="line"><span>        - &quot;--config.file=/etc/prometheus-webhook-dingtalk/config.yml&quot;</span></span>
<span class="line"><span>        volumeMounts:</span></span>
<span class="line"><span>        - name: webdingtalk-configmap</span></span>
<span class="line"><span>          mountPath: /etc/prometheus-webhook-dingtalk/</span></span>
<span class="line"><span>        ports:</span></span>
<span class="line"><span>        - containerPort: 8060</span></span>
<span class="line"><span>          protocol: TCP</span></span>
<span class="line"><span>        resources:</span></span>
<span class="line"><span>          requests:</span></span>
<span class="line"><span>            cpu: 100m</span></span>
<span class="line"><span>            memory: 100Mi</span></span>
<span class="line"><span>          limits:</span></span>
<span class="line"><span>            cpu: 200m</span></span>
<span class="line"><span>            memory: 500Mi</span></span>
<span class="line"><span>      volumes:</span></span>
<span class="line"><span>        - name: webdingtalk-configmap</span></span>
<span class="line"><span>          configMap:</span></span>
<span class="line"><span>            name: dingtalk-config</span></span>
<span class="line"><span>---</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Service</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    app: prometheus-webhook-dingtalk</span></span>
<span class="line"><span>  name: prometheus-webhook-dingtalk</span></span>
<span class="line"><span>  namespace: monitoring</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  ports:</span></span>
<span class="line"><span>  - port: 8060</span></span>
<span class="line"><span>    protocol: TCP</span></span>
<span class="line"><span>    targetPort: 8060</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    app: prometheus-webhook-dingtalk</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl create -f prometheus-webhook-dingtalk.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>检查</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl get -f prometheus-webhook-dingtalk.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="alertmanager配置" tabindex="-1"><a class="header-anchor" href="#alertmanager配置"><span>alertmanager配置</span></a></h3><p>编辑values.yaml文件</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim kube-prometheus-stack/values.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>增加钉钉发送通知配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>    route:</span></span>
<span class="line"><span>      receiver: dingtalk</span></span>
<span class="line"><span>    receivers:</span></span>
<span class="line"><span>    - name: &#39;dingtalk&#39;</span></span>
<span class="line"><span>      webhook_configs:</span></span>
<span class="line"><span>      - url: &#39;http://prometheus-webhook-dingtalk:8060/dingtalk/webhook1/send&#39;</span></span>
<span class="line"><span>        send_resolved: true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="更新配置-1" tabindex="-1"><a class="header-anchor" href="#更新配置-1"><span>更新配置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>helm upgrade  -n monitoring --create-namespace prometheus prometheus-community/kube-prometheus-stack  -f kube-prometheus-stack/values.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>检查</p><p><a href="http://192.168.11.65:9093/#/status" target="_blank" rel="noopener noreferrer">http://192.168.11.65:9093/#/status</a></p><h3 id="手动测试钉钉webhook接口" tabindex="-1"><a class="header-anchor" href="#手动测试钉钉webhook接口"><span>手动测试钉钉webhook接口</span></a></h3><p>需要把8060端口暴露出来，当然通过查看svc的集群ip也是可以的</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl port-forward --address=0.0.0.0 svc/prometheus-webhook-dingtalk  -n monitoring 8060:8060</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>手动测试</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>curl   -H &quot;Content-Type: application/json&quot;  -d &#39;{ &quot;version&quot;: &quot;4&quot;, &quot;status&quot;: &quot;firing&quot;, &quot;description&quot;:&quot;description_content&quot;}&#39; http://localhost:8060/dingtalk/webhook1/send</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="检查alertmanager日志-1" tabindex="-1"><a class="header-anchor" href="#检查alertmanager日志-1"><span>检查alertmanager日志</span></a></h3><p>当收不到告警信息，我们需要检查日志</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl --tail 10 alertmanager-prometheus-kube-prometheus-alertmanager-0 -n monitoring</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="碰到的问题" tabindex="-1"><a class="header-anchor" href="#碰到的问题"><span>碰到的问题</span></a></h3><p>由于配置名称错误导致不能发送报警信息给钉钉，如下图：<img src="`+i+`" alt="" loading="lazy"></p><p>解决：</p><p>把<code>prometheus-webhook-dingtalk.yaml</code>中的<code>webhook</code>改为<code>webhook1</code>，如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span> kubectl edit cm dingtalk-config -n monitoring</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>修改如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>data:</span></span>
<span class="line"><span>  config.yml: |</span></span>
<span class="line"><span>    targets:</span></span>
<span class="line"><span>      webhook1:</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_3、配置微信告警-webhook" tabindex="-1"><a class="header-anchor" href="#_3、配置微信告警-webhook"><span>3、配置微信告警（webhook）</span></a></h1><h3 id="安装prometheus-webhook-wechat" tabindex="-1"><a class="header-anchor" href="#安装prometheus-webhook-wechat"><span>安装prometheus-webhook-wechat</span></a></h3><p>webhook地址：</p><p><a href="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=" target="_blank" rel="noopener noreferrer">https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=</a></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt; prometheus-webhook-wechat.yaml &lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>---</span></span>
<span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: Deployment</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    app: prometheus-webhook-wechat</span></span>
<span class="line"><span>  name: prometheus-webhook-wechat</span></span>
<span class="line"><span>  namespace: monitoring</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  replicas: 1</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: prometheus-webhook-wechat</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: prometheus-webhook-wechat</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: prometheus-webhook-wechat</span></span>
<span class="line"><span>        image: linge365/webhook-wechat:latest</span></span>
<span class="line"><span>        imagePullPolicy: IfNotPresent</span></span>
<span class="line"><span>        env:</span></span>
<span class="line"><span>        - name: ROBOT_TOKEN</span></span>
<span class="line"><span>          value: &quot;自己的token&quot;</span></span>
<span class="line"><span>        ports:</span></span>
<span class="line"><span>        - containerPort: 5000</span></span>
<span class="line"><span>          protocol: TCP</span></span>
<span class="line"><span>        resources:</span></span>
<span class="line"><span>          requests:</span></span>
<span class="line"><span>            cpu: 100m</span></span>
<span class="line"><span>            memory: 100Mi</span></span>
<span class="line"><span>          limits:</span></span>
<span class="line"><span>            cpu: 200m</span></span>
<span class="line"><span>            memory: 500Mi</span></span>
<span class="line"><span>---</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Service</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    app: prometheus-webhook-wechat</span></span>
<span class="line"><span>  name: prometheus-webhook-wechat</span></span>
<span class="line"><span>  namespace: monitoring</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  ports:</span></span>
<span class="line"><span>  - port: 5000</span></span>
<span class="line"><span>    protocol: TCP</span></span>
<span class="line"><span>    targetPort: 5000</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    app: prometheus-webhook-wechat</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl create -f prometheus-webhook-wechat.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>检查</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl get -f prometheus-webhook-wechat.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="alertmanager配置-1" tabindex="-1"><a class="header-anchor" href="#alertmanager配置-1"><span>alertmanager配置</span></a></h3><p>编辑values.yaml文件</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim kube-prometheus-stack/values.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>增加微信发送通知配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>    route:</span></span>
<span class="line"><span>      receiver: wechat</span></span>
<span class="line"><span>    receivers:</span></span>
<span class="line"><span>    - name: &#39;wechat&#39;</span></span>
<span class="line"><span>      webhook_configs:</span></span>
<span class="line"><span>      - url: &#39;http://prometheus-webhook-wechat:5000&#39;</span></span>
<span class="line"><span>        send_resolved: true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="更新配置-2" tabindex="-1"><a class="header-anchor" href="#更新配置-2"><span>更新配置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>helm upgrade  -n monitoring --create-namespace prometheus kube-prometheus-stack</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>检查</p><p><a href="http://192.168.11.65:9093/#/status" target="_blank" rel="noopener noreferrer">http://192.168.11.65:9093/#/status</a></p><h3 id="手动测试微信webhook" tabindex="-1"><a class="header-anchor" href="#手动测试微信webhook"><span>手动测试微信webhook</span></a></h3><p>需要把5000端口暴露出来，当然通过查看svc的集群ip也是可以的</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span> kubectl port-forward --address=0.0.0.0 svc/prometheus-webhook-wechat  -n monitoring 5000:5000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>localhost根据实际修改</p><p>测试告警</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>curl -X POST -H &quot;Content-Type: application/json&quot; -d &#39;{</span></span>
<span class="line"><span>    &quot;alerts&quot;: [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>            &quot;status&quot;: &quot;firing&quot;,</span></span>
<span class="line"><span>            &quot;labels&quot;: {</span></span>
<span class="line"><span>                &quot;severity&quot;: &quot;critical&quot;,</span></span>
<span class="line"><span>                &quot;alertname&quot;: &quot;HighErrorRate&quot;,</span></span>
<span class="line"><span>                &quot;instance&quot;: &quot;server1&quot;</span></span>
<span class="line"><span>            },</span></span>
<span class="line"><span>            &quot;annotations&quot;: {</span></span>
<span class="line"><span>                &quot;summary&quot;: &quot;High error rate detected!&quot;,</span></span>
<span class="line"><span>                &quot;description&quot;: &quot;This is a description of the alert.&quot;</span></span>
<span class="line"><span>            },</span></span>
<span class="line"><span>            &quot;startsAt&quot;: &quot;2023-09-13T14:30:00Z&quot;,</span></span>
<span class="line"><span>            &quot;endsAt&quot;: &quot;2023-09-13T15:00:00Z&quot;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    ]</span></span>
<span class="line"><span>}&#39; http://localhost:5000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试恢复</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>curl -X POST -H &quot;Content-Type: application/json&quot; -d &#39;{</span></span>
<span class="line"><span>    &quot;alerts&quot;: [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>            &quot;status&quot;: &quot;resolved&quot;,</span></span>
<span class="line"><span>            &quot;labels&quot;: {</span></span>
<span class="line"><span>                &quot;severity&quot;: &quot;critical&quot;,</span></span>
<span class="line"><span>                &quot;alertname&quot;: &quot;HighErrorRate&quot;,</span></span>
<span class="line"><span>                &quot;instance&quot;: &quot;server1&quot;</span></span>
<span class="line"><span>            },</span></span>
<span class="line"><span>            &quot;annotations&quot;: {</span></span>
<span class="line"><span>                &quot;summary&quot;: &quot;High error rate resolved.&quot;,</span></span>
<span class="line"><span>                &quot;description&quot;: &quot;This is a description of the resolved alert.&quot;</span></span>
<span class="line"><span>            },</span></span>
<span class="line"><span>            &quot;startsAt&quot;: &quot;2023-09-13T15:00:00Z&quot;,</span></span>
<span class="line"><span>            &quot;endsAt&quot;: &quot;2023-09-13T15:30:00Z&quot;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    ]</span></span>
<span class="line"><span>}&#39; http://localhost:5000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="检查alertmanager日志-2" tabindex="-1"><a class="header-anchor" href="#检查alertmanager日志-2"><span>检查alertmanager日志</span></a></h3><p>当收不到告警信息，我们需要检查alertmanager日志</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl --tail 10 alertmanager-prometheus-kube-prometheus-alertmanager-0 -n monitoring</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h1 id="三、我的微信" tabindex="-1"><a class="header-anchor" href="#三、我的微信"><span>三、我的微信</span></a></h1><p>如果碰到问题，可以随时加我微信，谢谢</p><figure><img src="`+l+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',88),d=[t];function r(c,o){return a(),n("div",null,d)}const v=s(p,[["render",r],["__file","8.7.在k8s中使用钉钉，邮件，企业微信接收告警通知.html.vue"]]),m=JSON.parse('{"path":"/note/Prometheus/8.7.%E5%9C%A8k8s%E4%B8%AD%E4%BD%BF%E7%94%A8%E9%92%89%E9%92%89%EF%BC%8C%E9%82%AE%E4%BB%B6%EF%BC%8C%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5.html","title":"8.7.在k8s中使用钉钉，邮件，企业微信接收告警通知","lang":"zh-CN","frontmatter":{"title":"8.7.在k8s中使用钉钉，邮件，企业微信接收告警通知","order":49,"icon":"lightbulb","description":"一、环境 1、环境准备 kube-prometheus-stack工具集安装的prometheus 2、配置端口转发 使alertmanager的端口能外部访问 二、告警通知 因为kube-prometheus-stack的工具集已经带alertmanger的配置 1、配置邮件告警 具体配置如下图： 更新配置 检查 http://192.168.11....","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/note/Prometheus/8.7.%E5%9C%A8k8s%E4%B8%AD%E4%BD%BF%E7%94%A8%E9%92%89%E9%92%89%EF%BC%8C%E9%82%AE%E4%BB%B6%EF%BC%8C%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5.html"}],["meta",{"property":"og:site_name","content":"风华"}],["meta",{"property":"og:title","content":"8.7.在k8s中使用钉钉，邮件，企业微信接收告警通知"}],["meta",{"property":"og:description","content":"一、环境 1、环境准备 kube-prometheus-stack工具集安装的prometheus 2、配置端口转发 使alertmanager的端口能外部访问 二、告警通知 因为kube-prometheus-stack的工具集已经带alertmanger的配置 1、配置邮件告警 具体配置如下图： 更新配置 检查 http://192.168.11...."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"风华"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"8.7.在k8s中使用钉钉，邮件，企业微信接收告警通知\\",\\"image\\":[\\"\\"],\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"风华\\",\\"url\\":\\"/portfolio\\"}]}"]]},"headers":[{"level":2,"title":"1、环境准备","slug":"_1、环境准备","link":"#_1、环境准备","children":[]},{"level":2,"title":"2、配置端口转发","slug":"_2、配置端口转发","link":"#_2、配置端口转发","children":[]},{"level":2,"title":"1、配置邮件告警","slug":"_1、配置邮件告警","link":"#_1、配置邮件告警","children":[{"level":3,"title":"更新配置","slug":"更新配置","link":"#更新配置","children":[]},{"level":3,"title":"手动测试alertmanager接口","slug":"手动测试alertmanager接口","link":"#手动测试alertmanager接口","children":[]},{"level":3,"title":"检查alertmanager日志","slug":"检查alertmanager日志","link":"#检查alertmanager日志","children":[]}]},{"level":2,"title":"2、配置钉钉告警","slug":"_2、配置钉钉告警","link":"#_2、配置钉钉告警","children":[{"level":3,"title":"安装prometheus-webhook-dingtalk","slug":"安装prometheus-webhook-dingtalk","link":"#安装prometheus-webhook-dingtalk","children":[]},{"level":3,"title":"alertmanager配置","slug":"alertmanager配置","link":"#alertmanager配置","children":[]},{"level":3,"title":"更新配置","slug":"更新配置-1","link":"#更新配置-1","children":[]},{"level":3,"title":"手动测试钉钉webhook接口","slug":"手动测试钉钉webhook接口","link":"#手动测试钉钉webhook接口","children":[]},{"level":3,"title":"检查alertmanager日志","slug":"检查alertmanager日志-1","link":"#检查alertmanager日志-1","children":[]},{"level":3,"title":"碰到的问题","slug":"碰到的问题","link":"#碰到的问题","children":[]},{"level":3,"title":"安装prometheus-webhook-wechat","slug":"安装prometheus-webhook-wechat","link":"#安装prometheus-webhook-wechat","children":[]},{"level":3,"title":"alertmanager配置","slug":"alertmanager配置-1","link":"#alertmanager配置-1","children":[]},{"level":3,"title":"更新配置","slug":"更新配置-2","link":"#更新配置-2","children":[]},{"level":3,"title":"手动测试微信webhook","slug":"手动测试微信webhook","link":"#手动测试微信webhook","children":[]},{"level":3,"title":"检查alertmanager日志","slug":"检查alertmanager日志-2","link":"#检查alertmanager日志-2","children":[]}]}],"git":{},"readingTime":{"minutes":4.91,"words":1472},"filePathRelative":"note/Prometheus/8.7.在k8s中使用钉钉，邮件，企业微信接收告警通知.md","autoDesc":true}');export{v as comp,m as data};
