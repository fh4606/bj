import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as e,o as n,d as i}from"./app-BvlpFik8.js";const a="/assets/2023-10-28_202041_3664920.5567638537325506-CUSELgSI.png",t="/assets/2023-10-28_202041_9987730.9903452951917021-BmBDcjlF.png",l="/assets/2023-10-28_202041_4124560.5436195432907519-BjW9KrnS.png",d={},r=i(`<h1 id="一、环境" tabindex="-1"><a class="header-anchor" href="#一、环境"><span>一、环境</span></a></h1><table id="dd0d78c3" class="ne-table" style="table-layout:fixed;border-collapse:collapse;border:1px solid #d9d9d9;width:748px;"><tbody><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="ud0691b55" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">主机名</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u1ec16e40" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">IP地址</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ub27be396" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">系统</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u53074ba2" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">说明</span></p></td></tr><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="u2fa17bc4" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">localhost</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ud81713a0" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">192.168.11.61</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u446cd3d1" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">Ubuntu 20.04</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u507f2d94" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">docker安装的prometheus</span></p></td></tr><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="u48cd696c" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">test</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="uef3d418f" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">192.168.11.62</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u154985b7" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">Ubuntu 20.04</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ueb110c48" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">tengine 2.4.0</span></p></td></tr></tbody></table><h2 id="_1、环境准备" tabindex="-1"><a class="header-anchor" href="#_1、环境准备"><span>1、环境准备</span></a></h2><p>docker安装</p><p>略</p><p>docker-compose安装</p><p>略</p><h2 id="_2、安装tengine" tabindex="-1"><a class="header-anchor" href="#_2、安装tengine"><span>2、安装tengine</span></a></h2><h3 id="a、docker安装tengine带nginx-module-vts模块-二选一" tabindex="-1"><a class="header-anchor" href="#a、docker安装tengine带nginx-module-vts模块-二选一"><span>a、docker安装tengine带nginx-module-vts模块(二选一)</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>mkdir /data/ -p</span></span>
<span class="line"><span>cd /data/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>通过git clone下载已经创建好的docker-compose.yaml文件</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span> git clone https://gitee.com/linge365/docker-compose.git</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>运行</p><ul><li>带了nginx-module-vts模块</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cd docker-compose/tengine</span></span>
<span class="line"><span></span></span>
<span class="line"><span>docker-compose up -d</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>检查</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>docker ps</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>STATUS列为up 为正常</p><h3 id="b、编译安装的tengine安装nginx-module-vts模块-二选一" tabindex="-1"><a class="header-anchor" href="#b、编译安装的tengine安装nginx-module-vts模块-二选一"><span>b、编译安装的tengine安装nginx-module-vts模块（二选一）</span></a></h3><p>如果tengine是自行编译安装的，安装nginx-module-vts模块，如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#下载nginx-module-vts插件</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cd /usr/local/src/</span></span>
<span class="line"><span>git clone git://github.com/vozlt/nginx-module-vts.git</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重新编译nginx，指定nginx-module-vts目录</p><p>注：</p><ul><li>编译前记得备份原来的tengine目录。</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cd /usr/local/src/tengine-2.4.0  #进入到tengine源码目录</span></span>
<span class="line"><span>./configure  ...  --add-module=/usr/local/src/nginx-module-vts</span></span>
<span class="line"><span>make</span></span>
<span class="line"><span>make install</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="二、监控tengine" tabindex="-1"><a class="header-anchor" href="#二、监控tengine"><span>二、监控tengine</span></a></h1><h2 id="tengine开启status-docker安装的tengine" tabindex="-1"><a class="header-anchor" href="#tengine开启status-docker安装的tengine"><span>tengine开启status(docker安装的tengine)</span></a></h2><p>注：</p><ul><li>监控tengine我将使用第三方nginx-module-vts模块。</li></ul><p>检查是否安装有nginx-module-vts模块，nginx-module-vts模块已在上面的环境搭建安装好。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span> docker exec -it tengine nginx -V 2&gt;&amp;1 | grep -o nginx-module-vts</span></span>
<span class="line"><span>nginx-module-vts</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>tengine开启status全部配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>http {</span></span>
<span class="line"><span>    vhost_traffic_status_zone;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    server {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        location /status {</span></span>
<span class="line"><span>            vhost_traffic_status_display;</span></span>
<span class="line"><span>            vhost_traffic_status_display_format html;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改nginx的配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim conf/nginx.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>在http标签中加入vhost_traffic_status_zone配置。如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>http {</span></span>
<span class="line"><span>    vhost_traffic_status_zone;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改server.conf配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim conf/conf.d/default.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>在server标签中加入status如下配置：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>    server {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        location /status {</span></span>
<span class="line"><span>            vhost_traffic_status_display;</span></span>
<span class="line"><span>            vhost_traffic_status_display_format html;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>检查配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>docker exec -it tengine nginx -t</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>返回如下表示正常</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span></span>
<span class="line"><span>nginx: configuration file /etc/nginx/nginx.conf test is successful</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>重启</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>docker restart tengine</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>检查-有json数据返回表示正常</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>curl http://192.168.11.62/status/format/json</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>web检查-显示如下页面表示正常</p><figure><img src="`+a+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_1、二进制安装nginx-vts-exporter-二选一" tabindex="-1"><a class="header-anchor" href="#_1、二进制安装nginx-vts-exporter-二选一"><span>1、二进制安装nginx-vts-exporter（二选一）</span></a></h2><p>nginx-vts-exporter下载地址: <a href="https://github.com/hnlq715/nginx-vts-exporter/releases" target="_blank" rel="noopener noreferrer">https://github.com/hnlq715/nginx-vts-exporter/releases</a></p><h3 id="下载二进制包解压并放入-opt目录" tabindex="-1"><a class="header-anchor" href="#下载二进制包解压并放入-opt目录"><span>下载二进制包解压并放入/opt目录</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>wget https://github.com/hnlq715/nginx-vts-exporter/releases/download/v0.10.8/nginx-vtx-exporter_0.10.8_linux_amd64.tar.gz</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mkdir /opt/prometheus/nginx_vtx_exporter -p</span></span>
<span class="line"><span></span></span>
<span class="line"><span>tar xvf nginx-vtx-exporter_0.10.8_linux_amd64.tar.gz -C /opt/prometheus/nginx_vtx_exporter</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ls -l /opt/prometheus/nginx_vtx_exporter</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="创建用户" tabindex="-1"><a class="header-anchor" href="#创建用户"><span>创建用户</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>useradd -M -s /usr/sbin/nologin prometheus</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="更改exporter文件夹权限" tabindex="-1"><a class="header-anchor" href="#更改exporter文件夹权限"><span>更改exporter文件夹权限</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>chown prometheus:prometheus -R /opt/prometheus</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="创建-systemd-服务" tabindex="-1"><a class="header-anchor" href="#创建-systemd-服务"><span>创建 systemd 服务</span></a></h3><p>nginx_exporter.service</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt; /etc/systemd/system/nginx_vtx_exporter.service &lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>[Unit]</span></span>
<span class="line"><span>Description=nginx_vtx_exporter</span></span>
<span class="line"><span>After=network.target</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[Service]</span></span>
<span class="line"><span>Type=simple</span></span>
<span class="line"><span>User=prometheus</span></span>
<span class="line"><span>Group=prometheus</span></span>
<span class="line"><span>Restart=always</span></span>
<span class="line"><span>ExecStart=/opt/prometheus/nginx_vtx_exporter/nginx-vtx-exporter -nginx.scrape_uri=http://192.168.11.62/status/format/json</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[Install]</span></span>
<span class="line"><span>WantedBy=multi-user.target</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="启动-nginx-exporter" tabindex="-1"><a class="header-anchor" href="#启动-nginx-exporter"><span>启动 nginx_exporter</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>systemctl daemon-reload</span></span>
<span class="line"><span>systemctl start nginx_vtx_exporter.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="加入到开机自启动" tabindex="-1"><a class="header-anchor" href="#加入到开机自启动"><span>加入到开机自启动</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>systemctl enable nginx_vtx_exporter.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="检查" tabindex="-1"><a class="header-anchor" href="#检查"><span>检查</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>systemctl status nginx_vtx_exporter.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>启动不了检查日志</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>journalctl -u nginx_vtx_exporter.service -f</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_3、docker安装nginx-vts-exporter-二选一" tabindex="-1"><a class="header-anchor" href="#_3、docker安装nginx-vts-exporter-二选一"><span>3、docker安装nginx-vts-exporter（二选一）</span></a></h2><h3 id="docker-compose方式" tabindex="-1"><a class="header-anchor" href="#docker-compose方式"><span>docker-compose方式</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>mkdir /data/nginx_vts_exporter</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cd /data/nginx_vts_exporter</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过cat创建文件</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt;docker-compose.yaml &lt;&lt;EOF</span></span>
<span class="line"><span>version: &#39;3.3&#39;</span></span>
<span class="line"><span>services:</span></span>
<span class="line"><span>  nginx_vts_exporter:</span></span>
<span class="line"><span>    image: sophos/nginx-vts-exporter:latest</span></span>
<span class="line"><span>    container_name: nginx_vts_exporter</span></span>
<span class="line"><span>    environment:</span></span>
<span class="line"><span>      NGINX_STATUS: http://192.168.11.62/status/format/json</span></span>
<span class="line"><span>    restart: always</span></span>
<span class="line"><span>    ports:</span></span>
<span class="line"><span>      - &quot;9913:9913&quot;</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>docker-compose up -d</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>检查</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>docker ps</span></span>
<span class="line"><span>或：</span></span>
<span class="line"><span>docker logs -f nginx_vts_exporter</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3、参数解释" tabindex="-1"><a class="header-anchor" href="#_3、参数解释"><span>3、参数解释</span></a></h2><table id="c5975f3e" class="ne-table" style="table-layout:fixed;border-collapse:collapse;border:1px solid #d9d9d9;width:750px;"><tbody><tr style="height:33px;"><td width="250" style="border:1px solid #d9d9d9;"><p id="u49fdea69" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">Environment variable</span></p></td><td width="250" style="border:1px solid #d9d9d9;"><p id="ub4c46811" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">默认</span></p></td><td width="250" style="border:1px solid #d9d9d9;"><p id="u2fa9a69d" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">description</span></p></td></tr><tr style="height:33px;"><td width="250" style="border:1px solid #d9d9d9;"><p id="uae714215" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text" style="color:rgb(31, 35, 40);font-size:16px;">NGINX_STATUS</span></p></td><td width="250" style="border:1px solid #d9d9d9;"><p id="ua2fd3cd6" class="ne-p" style="margin:0;padding:0;min-height:24px;"><a href="http://localhost/status/format/json" data-href="http://localhost/status/format/json" target="_blank" class="ne-link"><span class="ne-text">http://localhost/status/format/json</span></a></p></td><td width="250" style="border:1px solid #d9d9d9;"><p id="u2b297874" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text"></span></p></td></tr></tbody></table><h2 id="_4、metrics地址" tabindex="-1"><a class="header-anchor" href="#_4、metrics地址"><span>4、metrics地址</span></a></h2><p>注：安装好Exporter后会暴露一个<code>http://ip:端口/metrics</code>的HTTP服务</p><table id="3af6df57" class="ne-table" style="table-layout:fixed;border-collapse:collapse;border:1px solid #d9d9d9;width:750px;"><tbody><tr style="height:33px;"><td width="250" style="border:1px solid #d9d9d9;"><p id="ud6d5952e" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">名称</span></p></td><td width="250" style="border:1px solid #d9d9d9;"><p id="u28886275" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">地址</span></p></td><td width="250" style="border:1px solid #d9d9d9;"><p id="udcaa0dc4" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">备注</span></p></td></tr><tr style="height:33px;"><td width="250" style="border:1px solid #d9d9d9;"><p id="u74998fa4" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">nginx-vts-exporter</span></p></td><td width="250" style="border:1px solid #d9d9d9;"><p id="u04948896" class="ne-p" style="margin:0;padding:0;min-height:24px;"><a href="http://192.168.11.62:9913/metrics" data-href="http://192.168.11.62:9913/metrics" target="_blank" class="ne-link"><span class="ne-text">http://192.168.11.62:9913/metrics</span></a></p></td><td width="250" style="border:1px solid #d9d9d9;"></td></tr></tbody></table><figure><img src="`+t+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_5、prometheus配置" tabindex="-1"><a class="header-anchor" href="#_5、prometheus配置"><span>5、Prometheus配置</span></a></h2><p>配置prometheus去采集（拉取）nginx_exporter的监控样本数据</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cd /data/docker-prometheus </span></span>
<span class="line"><span></span></span>
<span class="line"><span>#在scrape_configs(搜刮配置):下面增加如下配置：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cat &gt;&gt; prometheus/prometheus.yml &lt;&lt; &quot;EOF&quot;</span></span>
<span class="line"><span>  - job_name: &#39;nginx_vts_exporter&#39;</span></span>
<span class="line"><span>    static_configs:</span></span>
<span class="line"><span>    - targets: [&#39;192.168.11.62:9913&#39;]</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        instance: test服务器</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重新加载配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>curl -X POST http://localhost:9090/-/reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="检查-1" tabindex="-1"><a class="header-anchor" href="#检查-1"><span>检查</span></a></h3><p><a href="http://192.168.11.61:9090/targets?search=" target="_blank" rel="noopener noreferrer">http://192.168.11.61:9090/targets?search=</a></p><h2 id="_6、常用的监控指标" tabindex="-1"><a class="header-anchor" href="#_6、常用的监控指标"><span>6、常用的监控指标</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>nginx_server_connections{status=&quot;accepted&quot;} 接收请求数</span></span>
<span class="line"><span>nginx_server_connections{status=&quot;active&quot;} 活动连接数</span></span>
<span class="line"><span>nginx_server_connections{status=&quot;handled&quot;} 成功处理请求数</span></span>
<span class="line"><span>nginx_server_connections{status=&quot;reading&quot;} 正在进行读操作的请求数</span></span>
<span class="line"><span>nginx_server_connections{status=&quot;requests&quot;} 总请求数</span></span>
<span class="line"><span>nginx_server_connections{status=&quot;waiting&quot;} 正在等待的请求数</span></span>
<span class="line"><span>nginx_server_connections{status=&quot;writing&quot;} 正在进行写操作的请求数</span></span>
<span class="line"><span></span></span>
<span class="line"><span>nginx_upstream_requests{backend=&quot;xx:8080&quot;,code=&quot;4xx&quot;} 后端节点请求状态</span></span>
<span class="line"><span></span></span>
<span class="line"><span>nginx_server_requests{code=&quot;4xx&quot;,host=&quot;*&quot;}          状态码为4xx,所有主机</span></span>
<span class="line"><span>nginx_server_requests{code=&quot;4xx&quot;,host=&quot;localhost&quot;}  状态码为4xx,localhost主机</span></span>
<span class="line"><span>nginx_server_requests{code=&quot;5xx&quot;,host=&quot;*&quot;}          状态码为5xx,所有主机     </span></span>
<span class="line"><span>nginx_server_requests{code=&quot;5xx&quot;,host=&quot;localhost&quot;}  状态码为5xx,localhost主机</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+l+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_7、添加触发器" tabindex="-1"><a class="header-anchor" href="#_7、添加触发器"><span>7、添加触发器</span></a></h2><p>触发器</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cd /data/docker-prometheus</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>使用cat在alert.yml文件末尾追加。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt;&gt;prometheus/alert.yml &lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>- name: tengine</span></span>
<span class="line"><span>  rules:</span></span>
<span class="line"><span>  - alert: 客户端请求tengine非200</span></span>
<span class="line"><span>    expr: sum by (code) (rate(nginx_server_requests{code=~&quot;4xx|5xx&quot;}[2m])) &gt; 0</span></span>
<span class="line"><span>    for: 2m</span></span>
<span class="line"><span>    labels:</span></span>
<span class="line"><span>      severity: critical</span></span>
<span class="line"><span>    annotations:</span></span>
<span class="line"><span>      summary: &quot;客户端http请求异常&quot;</span></span>
<span class="line"><span>      description: &quot;HTTP状态码非 200-399&quot;</span></span>
<span class="line"><span>  - alert: tengine请求后端节点非200</span></span>
<span class="line"><span>    expr: sum by (code) (rate(nginx_upstream_requests{code=~&quot;4xx|5xx&quot;}[2m])) &gt; 0</span></span>
<span class="line"><span>    for: 2m</span></span>
<span class="line"><span>    labels:</span></span>
<span class="line"><span>      severity: critical</span></span>
<span class="line"><span>    annotations:</span></span>
<span class="line"><span>      summary: &quot;后端节点http请求异常&quot;</span></span>
<span class="line"><span>      description: &quot;后端节点请求状态码非 200-399&quot;</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注</p><ul><li>2个触发器大部分重复（如：tengine请求后端节点返回500，那tengine也会给客户端返回500）</li></ul><p>检查：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim prometheus/alert.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="检查配置" tabindex="-1"><a class="header-anchor" href="#检查配置"><span>检查配置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>docker exec -it prometheus promtool check config /etc/prometheus/prometheus.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>返回ok，表示配置没有问题</p><h3 id="重新加载配置" tabindex="-1"><a class="header-anchor" href="#重新加载配置"><span>重新加载配置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>curl -X POST http://localhost:9090/-/reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="检查-2" tabindex="-1"><a class="header-anchor" href="#检查-2"><span>检查</span></a></h3><p><a href="http://192.168.11.61:9090/alerts?search=" target="_blank" rel="noopener noreferrer">http://192.168.11.61:9090/alerts?search=</a></p><p>或：</p><p><a href="http://192.168.11.61:9090/rules" target="_blank" rel="noopener noreferrer">http://192.168.11.61:9090/rules</a></p><h2 id="_8、dashboard" tabindex="-1"><a class="header-anchor" href="#_8、dashboard"><span>8、dashboard</span></a></h2><p>grafana展示prometheus从nginx_exporter收集到的的数据</p><p><a href="https://grafana.com/grafana/dashboards/2949" target="_blank" rel="noopener noreferrer">https://grafana.com/grafana/dashboards/2949</a></p>`,116),p=[r];function c(h,o){return n(),e("div",null,p)}const v=s(d,[["render",c],["__file","2.3.监控tengine（新增）.html.vue"]]),b=JSON.parse('{"path":"/note/Prometheus/2.3.%E7%9B%91%E6%8E%A7tengine%EF%BC%88%E6%96%B0%E5%A2%9E%EF%BC%89.html","title":"2.3.监控tengine（新增）","lang":"zh-CN","frontmatter":{"title":"2.3.监控tengine（新增）","order":9,"icon":"lightbulb","description":"一、环境 1、环境准备 docker安装 略 docker-compose安装 略 2、安装tengine a、docker安装tengine带nginx-module-vts模块(二选一) 通过git clone下载已经创建好的docker-compose.yaml文件 运行 带了nginx-module-vts模块 检查 STATUS列为up 为正...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/note/Prometheus/2.3.%E7%9B%91%E6%8E%A7tengine%EF%BC%88%E6%96%B0%E5%A2%9E%EF%BC%89.html"}],["meta",{"property":"og:site_name","content":"风华"}],["meta",{"property":"og:title","content":"2.3.监控tengine（新增）"}],["meta",{"property":"og:description","content":"一、环境 1、环境准备 docker安装 略 docker-compose安装 略 2、安装tengine a、docker安装tengine带nginx-module-vts模块(二选一) 通过git clone下载已经创建好的docker-compose.yaml文件 运行 带了nginx-module-vts模块 检查 STATUS列为up 为正..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"风华"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"2.3.监控tengine（新增）\\",\\"image\\":[\\"\\"],\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"风华\\",\\"url\\":\\"/portfolio\\"}]}"]]},"headers":[{"level":2,"title":"1、环境准备","slug":"_1、环境准备","link":"#_1、环境准备","children":[]},{"level":2,"title":"2、安装tengine","slug":"_2、安装tengine","link":"#_2、安装tengine","children":[{"level":3,"title":"a、docker安装tengine带nginx-module-vts模块(二选一)","slug":"a、docker安装tengine带nginx-module-vts模块-二选一","link":"#a、docker安装tengine带nginx-module-vts模块-二选一","children":[]},{"level":3,"title":"b、编译安装的tengine安装nginx-module-vts模块（二选一）","slug":"b、编译安装的tengine安装nginx-module-vts模块-二选一","link":"#b、编译安装的tengine安装nginx-module-vts模块-二选一","children":[]}]},{"level":2,"title":"tengine开启status(docker安装的tengine)","slug":"tengine开启status-docker安装的tengine","link":"#tengine开启status-docker安装的tengine","children":[]},{"level":2,"title":"1、二进制安装nginx-vts-exporter（二选一）","slug":"_1、二进制安装nginx-vts-exporter-二选一","link":"#_1、二进制安装nginx-vts-exporter-二选一","children":[{"level":3,"title":"下载二进制包解压并放入/opt目录","slug":"下载二进制包解压并放入-opt目录","link":"#下载二进制包解压并放入-opt目录","children":[]},{"level":3,"title":"创建用户","slug":"创建用户","link":"#创建用户","children":[]},{"level":3,"title":"更改exporter文件夹权限","slug":"更改exporter文件夹权限","link":"#更改exporter文件夹权限","children":[]},{"level":3,"title":"创建 systemd 服务","slug":"创建-systemd-服务","link":"#创建-systemd-服务","children":[]},{"level":3,"title":"启动 nginx_exporter","slug":"启动-nginx-exporter","link":"#启动-nginx-exporter","children":[]},{"level":3,"title":"加入到开机自启动","slug":"加入到开机自启动","link":"#加入到开机自启动","children":[]},{"level":3,"title":"检查","slug":"检查","link":"#检查","children":[]}]},{"level":2,"title":"3、docker安装nginx-vts-exporter（二选一）","slug":"_3、docker安装nginx-vts-exporter-二选一","link":"#_3、docker安装nginx-vts-exporter-二选一","children":[{"level":3,"title":"docker-compose方式","slug":"docker-compose方式","link":"#docker-compose方式","children":[]}]},{"level":2,"title":"3、参数解释","slug":"_3、参数解释","link":"#_3、参数解释","children":[]},{"level":2,"title":"4、metrics地址","slug":"_4、metrics地址","link":"#_4、metrics地址","children":[]},{"level":2,"title":"5、Prometheus配置","slug":"_5、prometheus配置","link":"#_5、prometheus配置","children":[{"level":3,"title":"检查","slug":"检查-1","link":"#检查-1","children":[]}]},{"level":2,"title":"6、常用的监控指标","slug":"_6、常用的监控指标","link":"#_6、常用的监控指标","children":[]},{"level":2,"title":"7、添加触发器","slug":"_7、添加触发器","link":"#_7、添加触发器","children":[{"level":3,"title":"检查配置","slug":"检查配置","link":"#检查配置","children":[]},{"level":3,"title":"重新加载配置","slug":"重新加载配置","link":"#重新加载配置","children":[]},{"level":3,"title":"检查","slug":"检查-2","link":"#检查-2","children":[]}]},{"level":2,"title":"8、dashboard","slug":"_8、dashboard","link":"#_8、dashboard","children":[]}],"git":{},"readingTime":{"minutes":6.62,"words":1985},"filePathRelative":"note/Prometheus/2.3.监控tengine（新增）.md","autoDesc":true}');export{v as comp,b as data};
