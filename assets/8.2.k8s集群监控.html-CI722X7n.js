import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as e,o as n,d as a}from"./app-DZWWIkr0.js";const i="/bj/assets/2023-10-28_210617_8476620.5443032005576681-BWbcQ7QG.png",l="/bj/assets/2023-10-28_210618_2889270.5361803295706882-DCLUd2Eq.png",p="/bj/assets/2023-10-28_210618_1313150.6995802617487757-C0a8Fm03.png",r="/bj/assets/2023-10-28_210617_7043870.7695009726106039-CXgg-7mJ.png",t="/bj/assets/2023-10-28_202232_3157980.3417943973584434-fzbfidHN.png",d={},c=a(`<h1 id="一、环境" tabindex="-1"><a class="header-anchor" href="#一、环境"><span>一、环境</span></a></h1><table id="01409c3a" class="ne-table" style="table-layout:fixed;border-collapse:collapse;border:1px solid #d9d9d9;width:748px;"><tbody><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="u1ee7ab7a" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">主机名</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ueb742f8c" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">IP地址</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ub0441c4c" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">系统</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ue4423d15" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">说明</span></p></td></tr><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="u9a6be349" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">k8s</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u3b5a39f4" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">192.168.11.65</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u81f633b3" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">Ubuntu 20.04</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u3dcaa7fb" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">k8s版本：v1.23.10 单机版本</span></p></td></tr></tbody></table><p>准备环境</p><p>通过克隆的方式准备了一台全新的Ubuntu 20.04服务器（4核8g）</p><h2 id="_1、设置主机名为k8s" tabindex="-1"><a class="header-anchor" href="#_1、设置主机名为k8s"><span>1、设置主机名为k8s</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>sudo hostnamectl set-hostname k8s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_2、使用kubekey安装k8s" tabindex="-1"><a class="header-anchor" href="#_2、使用kubekey安装k8s"><span>2、使用KubeKey安装k8s</span></a></h2><p><a href="https://github.com/kubesphere/kubekey" target="_blank" rel="noopener noreferrer">KubeKey github地址</a></p><h3 id="系统要求" tabindex="-1"><a class="header-anchor" href="#系统要求"><span>系统要求</span></a></h3><p>使用kubekey安装k8s要求的系统及版本</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>Ubuntu 16.04, 18.04, 20.04, 22.04</span></span>
<span class="line"><span>Debian Buster, Stretch</span></span>
<span class="line"><span>CentOS/RHEL 7</span></span>
<span class="line"><span>AlmaLinux 9.0</span></span>
<span class="line"><span>SUSE Linux Enterprise Server 15</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装k8s单机版" tabindex="-1"><a class="header-anchor" href="#安装k8s单机版"><span>安装k8s单机版</span></a></h3><ul><li>因为我是测试，所以安装k8s单机版，生产一般建议最少3台</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#下载KubeKey</span></span>
<span class="line"><span>export KKZONE=cn</span></span>
<span class="line"><span>curl -sfL https://get-kk.kubesphere.io | VERSION=v3.0.7 sh -</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#创建配置文件</span></span>
<span class="line"><span>./kk create config --name linge</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#修改配置文件。linge是上步指定的名称</span></span>
<span class="line"><span>vim config-linge.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#安装依赖</span></span>
<span class="line"><span>apt -y install socat conntrack</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#安装k8s命令</span></span>
<span class="line"><span>./kk create  cluster -f config-linge.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#检查命令</span></span>
<span class="line"><span>kubectl get pod -A</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>安装完成后检查，全部running表示正常</p><figure><img src="`+i+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在 Kubernetes 集群中创建一个 pod， 验证是否正常运行</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#创建nginx容器</span></span>
<span class="line"><span>kubectl create deployment nginx --image=nginx</span></span>
<span class="line"><span>#暴露nginx端口</span></span>
<span class="line"><span>kubectl expose deployment nginx --port=80 --type=NodePort</span></span>
<span class="line"><span># 查看pod以及服务</span></span>
<span class="line"><span>kubectl get pod,svc</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="http://192.168.11.65" target="_blank" rel="noopener noreferrer">http://192.168.11.65</a>:nodeport/</p><h3 id="安装k8s单机版配置" tabindex="-1"><a class="header-anchor" href="#安装k8s单机版配置"><span>安装k8s单机版配置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>root@k8s:~# cat config-linge.yaml </span></span>
<span class="line"><span></span></span>
<span class="line"><span>apiVersion: kubekey.kubesphere.io/v1alpha2</span></span>
<span class="line"><span>kind: Cluster</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: linge</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  hosts:</span></span>
<span class="line"><span>  - {name: k8s, address: 192.168.11.65, internalAddress: 192.168.11.65, user: linge, password: &quot;xxx&quot;}</span></span>
<span class="line"><span>  roleGroups:</span></span>
<span class="line"><span>    etcd:</span></span>
<span class="line"><span>    - k8s</span></span>
<span class="line"><span>    control-plane:</span></span>
<span class="line"><span>    - k8s</span></span>
<span class="line"><span>    worker:</span></span>
<span class="line"><span>    - k8s</span></span>
<span class="line"><span>  controlPlaneEndpoint:</span></span>
<span class="line"><span>    ## Internal loadbalancer for apiservers </span></span>
<span class="line"><span>    # internalLoadbalancer: haproxy</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    domain: lb.kubesphere.local</span></span>
<span class="line"><span>    address: &quot;&quot;</span></span>
<span class="line"><span>    port: 6443</span></span>
<span class="line"><span>  kubernetes:</span></span>
<span class="line"><span>    #指定k8s版本</span></span>
<span class="line"><span>    version: v1.23.10</span></span>
<span class="line"><span>    clusterName: cluster.local</span></span>
<span class="line"><span>    autoRenewCerts: true</span></span>
<span class="line"><span>    containerManager: docker</span></span>
<span class="line"><span>  etcd:</span></span>
<span class="line"><span>    type: kubekey</span></span>
<span class="line"><span>  network:</span></span>
<span class="line"><span>    plugin: calico</span></span>
<span class="line"><span>    kubePodsCIDR: 10.233.64.0/18</span></span>
<span class="line"><span>    kubeServiceCIDR: 10.233.0.0/18</span></span>
<span class="line"><span>    ## multus support. https://github.com/k8snetworkplumbingwg/multus-cni</span></span>
<span class="line"><span>    multusCNI:</span></span>
<span class="line"><span>      enabled: false</span></span>
<span class="line"><span>  registry:</span></span>
<span class="line"><span>    privateRegistry: &quot;&quot;</span></span>
<span class="line"><span>    namespaceOverride: &quot;&quot;</span></span>
<span class="line"><span>    registryMirrors: []</span></span>
<span class="line"><span>    insecureRegistries: []</span></span>
<span class="line"><span>  addons: []</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>安装截图</p><figure><img src="`+l+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="添加新节点" tabindex="-1"><a class="header-anchor" href="#添加新节点"><span>添加新节点</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#编辑之前通过./kk创建的配置文件，</span></span>
<span class="line"><span>vim config-linge.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#添加如下配置，注意192.168.11.67为新node的ip，name为计算机名</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  hosts:</span></span>
<span class="line"><span>  - {name: node2, address: 192.168.11.67, internalAddress: 192.168.11.67, user: linge, password: &quot;cdring&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#执行添加命令</span></span>
<span class="line"><span>./kk add nodes -f config-sample.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#等待自动完成</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="二、在k8s中安装prometheus-operator" tabindex="-1"><a class="header-anchor" href="#二、在k8s中安装prometheus-operator"><span>二、在K8S中安装Prometheus Operator</span></a></h1><p>是<strong>一个由CoreOS 团队开发的开源Prometheus 工具集</strong>，它将Prometheus、Grafana、Alertmanager、Service Discovery 和其他监控相关的组件打包在一起，方便在Kubernetes 环境中部署和使用</p><ul><li><p><a href="https://github.com/prometheus-operator/prometheus-operator" target="_blank" rel="noopener noreferrer">prometheus-operator GitHub地址</a> <code>通过kubectl create安装</code></p></li><li><p><a href="https://github.com/prometheus-operator/kube-prometheus" target="_blank" rel="noopener noreferrer">kube-prometheus GitHub地址</a> <code>通过kubectl create安装</code></p></li><li><p><a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack" target="_blank" rel="noopener noreferrer">kube-prometheus-stack GitHub地址</a> <code>通过helm安装</code></p></li></ul><h2 id="_1、安装kube-prometheus-stack" tabindex="-1"><a class="header-anchor" href="#_1、安装kube-prometheus-stack"><span>1、安装kube-prometheus-stack</span></a></h2><p>通过添加prometheus-community仓库把kube-prometheus-stack包下载下来，需要“梯子”</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</span></span>
<span class="line"><span></span></span>
<span class="line"><span>helm repo update</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#把包下载下来</span></span>
<span class="line"><span>helm fetch prometheus-community/kube-prometheus-stack</span></span>
<span class="line"><span></span></span>
<span class="line"><span>tar xf kube-prometheus-stack-45.8.0.tgz</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过wget下载</p><p><a href="https://github.com/prometheus-community/helm-charts/releases" target="_blank" rel="noopener noreferrer">下载地址</a></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>wget https://github.com/prometheus-community/helm-charts/releases/download/kube-prometheus-stack-45.8.0/kube-prometheus-stack-45.8.0.tgz</span></span>
<span class="line"><span></span></span>
<span class="line"><span>tar xf kube-prometheus-stack-45.8.0.tgz</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="修改镜像源" tabindex="-1"><a class="header-anchor" href="#修改镜像源"><span>修改镜像源</span></a></h3><p>国外镜像源某些镜像无法拉取，我们这里修改prometheus-operator，prometheus，alertmanager，kube-state-metrics，node-exporter的镜像源为国内镜像源。我这里使用的是中科大的镜像源。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#检查</span></span>
<span class="line"><span>grep -A 2 &#39;image:&#39; kube-prometheus-stack/*</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#批量替换</span></span>
<span class="line"><span>sed -i &#39;s/quay.io/quay.mirrors.ustc.edu.cn/g&#39; \`grep &quot;quay.io&quot; -rl kube-prometheus-stack/*\`</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>docker pull registry.aliyuncs.com/google_containers/kube-webhook-certgen:v20221220-controller-v1.5.1-58-g787ea74b6</span></span>
<span class="line"><span></span></span>
<span class="line"><span>docker tag registry.aliyuncs.com/google_containers/kube-webhook-certgen:v20221220-controller-v1.5.1-58-g787ea74b6 registry.k8s.io/ingress-nginx/kube-webhook-certgen:v20221220-controller-v1.5.1-58-g787ea74b6</span></span>
<span class="line"><span></span></span>
<span class="line"><span>docker pull bitnami/kube-state-metrics:2.8.2</span></span>
<span class="line"><span>docker tag bitnami/kube-state-metrics:2.8.2 registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.8.2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改配置文件</p><ul><li>修改grafana的密码</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim kube-prometheus-stack/values.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>grafana:</span></span>
<span class="line"><span>  adminPassword: 填写自己的密码</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或：使用sed修改</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>sed -i &#39;s#adminPassword: prom-operator#adminPassword: password#g&#39; kube-prometheus-stack/values.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>本地安装</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>helm install  -n monitoring --create-namespace prometheus kube-prometheus-stack</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>检查pod</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>root@k8s:~# kubectl get pod -n monitoring</span></span>
<span class="line"><span>NAME                                                     READY   STATUS    RESTARTS      AGE</span></span>
<span class="line"><span>alertmanager-prometheus-kube-prometheus-alertmanager-0   2/2     Running   1 (16h ago)   16h</span></span>
<span class="line"><span>prometheus-blackbox-exporter-57576d69b9-tz4rc            1/1     Running   0             15h</span></span>
<span class="line"><span>prometheus-grafana-894b6bd64-jxg82                       3/3     Running   0             16h</span></span>
<span class="line"><span>prometheus-kube-prometheus-operator-84cdc87db8-nmdsj     1/1     Running   0             16h</span></span>
<span class="line"><span>prometheus-kube-state-metrics-78685d656f-kt4vl           1/1     Running   0             16h</span></span>
<span class="line"><span>prometheus-mysql-exporter-84d44dd7d8-c65bs               1/1     Running   0             14m</span></span>
<span class="line"><span>prometheus-prometheus-kube-prometheus-prometheus-0       2/2     Running   0             16h</span></span>
<span class="line"><span>prometheus-prometheus-node-exporter-q2g5v                1/1     Running   0             16h</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>检查svc</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>root@k8s:~# kubectl get svc -n monitoring</span></span>
<span class="line"><span>NAME                                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span></span>
<span class="line"><span>prometheus-grafana                        ClusterIP   10.233.59.19    &lt;none&gt;        80/TCP                       43h</span></span>
<span class="line"><span>prometheus-kube-prometheus-alertmanager   ClusterIP   10.233.17.147   &lt;none&gt;        9093/TCP                     43h                  43h</span></span>
<span class="line"><span>prometheus-kube-prometheus-prometheus     ClusterIP   10.233.0.59     &lt;none&gt;        9090/TCP                     43h</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>检查deploy</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>root@k8s:~# kubectl get deploy -n monitoring</span></span>
<span class="line"><span>NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE</span></span>
<span class="line"><span>prometheus-grafana                    1/1     1            1           4h7m</span></span>
<span class="line"><span>prometheus-kube-prometheus-operator   1/1     1            1           4h7m</span></span>
<span class="line"><span>prometheus-kube-state-metrics         1/1     1            1           4h7m</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="配置外部访问地址" tabindex="-1"><a class="header-anchor" href="#配置外部访问地址"><span>配置外部访问地址</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl port-forward --address=0.0.0.0 svc/prometheus-kube-prometheus-prometheus -n monitoring 9090:9090 &amp;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>kubectl port-forward --address=0.0.0.0 svc/prometheus-kube-prometheus-alertmanager -n monitoring 9093:9093 &amp;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>kubectl port-forward --address=0.0.0.0 svc/prometheus-grafana -n monitoring 3000:80 &amp;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="http://192.168.11.65:9090" target="_blank" rel="noopener noreferrer">http://192.168.11.65:9090</a></p><p><a href="http://192.168.11.65:9093" target="_blank" rel="noopener noreferrer">http://192.168.11.65:9093</a></p><p><a href="http://192.168.11.65:3000" target="_blank" rel="noopener noreferrer">http://192.168.11.65:3000</a></p><h3 id="查看四类自定义资源" tabindex="-1"><a class="header-anchor" href="#查看四类自定义资源"><span>查看四类自定义资源</span></a></h3><ul><li><p>Prometheus：声明式创建和管理Prometheus Server实例；</p></li><li><p>ServiceMonitor：负责声明式的管理监控配置；</p></li><li><p>PrometheusRule：负责声明式的管理告警配置；</p></li><li><p>Alertmanager：声明式的创建和管理Alertmanager实例。</p></li></ul><p>查看Prometheus</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl get prometheus -n monitoring prometheus-kube-prometheus-prometheus -oyaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  podMonitorSelector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      release: prometheus</span></span>
<span class="line"><span>  #选择label为如下的probe</span></span>
<span class="line"><span>  probeSelector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      release: prometheus</span></span>
<span class="line"><span>  #选择label为如下的PrometheusRule</span></span>
<span class="line"><span>  ruleSelector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      release: prometheus</span></span>
<span class="line"><span>  #选择label为如下的serviceMonitor</span></span>
<span class="line"><span>  serviceMonitorSelector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      release: prometheus</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>matchLabels</code>用于定义一组Label</p><p>查看Alertmanager</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl get Alertmanager -n monitoring prometheus-kube-prometheus-alertmanager -oyaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>查看ServiceMonitor</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl get servicemonitors -n monitoring</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>查看PrometheusRule</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl get prometheusrules -n monitoring</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="碰到的问题" tabindex="-1"><a class="header-anchor" href="#碰到的问题"><span>碰到的问题</span></a></h3><h4 id="问题1" tabindex="-1"><a class="header-anchor" href="#问题1"><span>问题1：</span></a></h4><p>监控kube-proxy有问题，如下图：</p><figure><img src="`+p+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>解决</p><p>编辑kube-proxy配置文件</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl edit cm/kube-proxy -n kube-system</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>把<code>metricsBindAddress: &quot;&quot;</code>修改为<code>metricsBindAddress: 0.0.0.0</code></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span> ...</span></span>
<span class="line"><span>    kind: KubeProxyConfiguration</span></span>
<span class="line"><span>    metricsBindAddress: 0.0.0.0</span></span>
<span class="line"><span> ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>删除pod，重启kube-proxy</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>重启后检查</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl get pod -l k8s-app=kube-proxy -n kube-system</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><a href="http://192.168.11.65:9090/targets?search=" target="_blank" rel="noopener noreferrer">http://192.168.11.65:9090/targets?search=</a></p><h4 id="问题2" tabindex="-1"><a class="header-anchor" href="#问题2"><span>问题2:</span></a></h4><p>描述：kube-controller-manager 和 kube-scheduler的监控也有问题，如下图：</p><figure><img src="`+r+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>解决：</p><p>在每台master节点执行</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim /etc/kubernetes/manifests/kube-scheduler.yaml</span></span>
<span class="line"><span>将</span></span>
<span class="line"><span>--bind-address=127.0.0.1</span></span>
<span class="line"><span>改为</span></span>
<span class="line"><span>--bind-address=0.0.0.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim /etc/kubernetes/manifests/kube-controller-manager.yaml</span></span>
<span class="line"><span>将</span></span>
<span class="line"><span>--bind-address=127.0.0.1</span></span>
<span class="line"><span>改为</span></span>
<span class="line"><span>--bind-address=0.0.0.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启kubelet</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>systemctl restart kubelet.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="问题3" tabindex="-1"><a class="header-anchor" href="#问题3"><span>问题3：</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl describe pod prometheus-kube-prometheus-admission-create-8jmhj -n monitoring</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>从registry.k8s.io下载ingress-nginx/kube-webhook-certgen下载失败</p><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688098673275-25990f80-6fda-4208-a67f-81859551b1a4.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>解决：</p><p>把registry.k8s.io仓库地址修改为中科大的仓库地址，修改方法见上面的“修改镜像源”</p><h4 id="问题4" tabindex="-1"><a class="header-anchor" href="#问题4"><span>问题4：</span></a></h4><p>从registry.k8s.io下载kube-state-metrics失败</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl describe pod prometheus-kube-state-metrics-78685d656f-sz66n -n monitoring</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688098673260-07132a9e-e476-4a5c-9223-fc86edd70a9d.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>解决：</p><p>把registry.k8s.io仓库地址修改为中科大的仓库地址，修改方法见上面的“修改镜像源”</p><h1 id="三、我的微信" tabindex="-1"><a class="header-anchor" href="#三、我的微信"><span>三、我的微信</span></a></h1><p>如果碰到问题，可以随时加我微信，谢谢</p><figure><img src="`+t+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',104),h=[c];function u(o,b){return n(),e("div",null,h)}const g=s(d,[["render",u],["__file","8.2.k8s集群监控.html.vue"]]),k=JSON.parse('{"path":"/note/Prometheus/8.2.k8s%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7.html","title":"8.2.k8s集群监控","lang":"zh-CN","frontmatter":{"title":"8.2.k8s集群监控","order":44,"icon":"lightbulb","description":"一、环境 准备环境 通过克隆的方式准备了一台全新的Ubuntu 20.04服务器（4核8g） 1、设置主机名为k8s 2、使用KubeKey安装k8s KubeKey github地址 系统要求 使用kubekey安装k8s要求的系统及版本 安装k8s单机版 因为我是测试，所以安装k8s单机版，生产一般建议最少3台 安装完成后检查，全部running表...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/bj/note/Prometheus/8.2.k8s%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7.html"}],["meta",{"property":"og:site_name","content":"风华"}],["meta",{"property":"og:title","content":"8.2.k8s集群监控"}],["meta",{"property":"og:description","content":"一、环境 准备环境 通过克隆的方式准备了一台全新的Ubuntu 20.04服务器（4核8g） 1、设置主机名为k8s 2、使用KubeKey安装k8s KubeKey github地址 系统要求 使用kubekey安装k8s要求的系统及版本 安装k8s单机版 因为我是测试，所以安装k8s单机版，生产一般建议最少3台 安装完成后检查，全部running表..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688098673275-25990f80-6fda-4208-a67f-81859551b1a4.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"风华"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"8.2.k8s集群监控\\",\\"image\\":[\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688098673275-25990f80-6fda-4208-a67f-81859551b1a4.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\",\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688098673260-07132a9e-e476-4a5c-9223-fc86edd70a9d.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\"],\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"风华\\",\\"url\\":\\"/portfolio\\"}]}"]]},"headers":[{"level":2,"title":"1、设置主机名为k8s","slug":"_1、设置主机名为k8s","link":"#_1、设置主机名为k8s","children":[]},{"level":2,"title":"2、使用KubeKey安装k8s","slug":"_2、使用kubekey安装k8s","link":"#_2、使用kubekey安装k8s","children":[{"level":3,"title":"系统要求","slug":"系统要求","link":"#系统要求","children":[]},{"level":3,"title":"安装k8s单机版","slug":"安装k8s单机版","link":"#安装k8s单机版","children":[]},{"level":3,"title":"安装k8s单机版配置","slug":"安装k8s单机版配置","link":"#安装k8s单机版配置","children":[]},{"level":3,"title":"添加新节点","slug":"添加新节点","link":"#添加新节点","children":[]}]},{"level":2,"title":"1、安装kube-prometheus-stack","slug":"_1、安装kube-prometheus-stack","link":"#_1、安装kube-prometheus-stack","children":[{"level":3,"title":"修改镜像源","slug":"修改镜像源","link":"#修改镜像源","children":[]},{"level":3,"title":"配置外部访问地址","slug":"配置外部访问地址","link":"#配置外部访问地址","children":[]},{"level":3,"title":"查看四类自定义资源","slug":"查看四类自定义资源","link":"#查看四类自定义资源","children":[]},{"level":3,"title":"碰到的问题","slug":"碰到的问题","link":"#碰到的问题","children":[]}]}],"git":{},"readingTime":{"minutes":6.11,"words":1832},"filePathRelative":"note/Prometheus/8.2.k8s集群监控.md","autoDesc":true}');export{g as comp,k as data};
