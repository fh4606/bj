import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,o as a,d as e}from"./app-Bna6fuy1.js";const i="/assets/2023-10-28_204811_3218870.16815246633441838-Ble4XbUe.png",l="/assets/2023-10-28_204811_3476840.39989242553918736-DNWgdngO.png",p="/assets/2023-10-28_204811_4488700.6905436310299812-B4EILyTg.png",d="/assets/2023-10-28_204811_6167330.13376326569268682-DR8blQWk.png",t={},r=e('<h1 id="一、环境" tabindex="-1"><a class="header-anchor" href="#一、环境"><span>一、环境</span></a></h1><table id="1f7031f2" class="ne-table" style="table-layout:fixed;border-collapse:collapse;border:1px solid #d9d9d9;width:748px;"><tbody><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="u68835f94" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">主机名</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ud3339ee1" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">IP地址</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u0da537c3" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">系统</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u9e262a65" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">说明</span></p></td></tr><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="u4fcd4ef5" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">localhost</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u88c89626" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">192.168.11.61</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ubc8c0d68" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">Ubuntu 20.04</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u160762ef" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">docker安装的prometheus</span></p></td></tr><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="u301af1a1" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">test</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u6879545e" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">192.168.11.62</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u912c1fbd" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">Ubuntu 20.04</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="uab750a9e" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">已经完成了rabbitmq，mysql，redis，nginx等基于配置文件的监控</span></p></td></tr></tbody></table><h1 id="二、服务发现" tabindex="-1"><a class="header-anchor" href="#二、服务发现"><span>二、服务发现</span></a></h1><p>接下来我们将学习 Prometheus 中是如何使用服务发现来查找和抓取目标的。我们知道在 Prometheus 配置文件中可以通过一个 <code>static_configs</code> 来配置静态的抓取任务，但是在云环境下，特别是容器环境下，抓取目标地址是经常变动的，所以用静态的方式就不能满足这些场景了，还有特别在很多服务器需要监控时。所以我们需要监控系统能够动态感知这个变化，不可能每次变动都去手动重新配置的，为了应对复杂的动态环境，Prometheus 也提供了与基础设施中的服务发现集成的功能。</p><figure><img src="'+i+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Prometheus 已经支持多种内置的服务发现机制：</p><ul><li><p>发现云服务商的 VM 虚拟机</p></li><li><p>Kubernetes 上的自动发现</p></li><li><p>通用的服务查找，例如 DNS、Consul、Zookeeper 或自定义发现机制</p></li></ul><p>我们都可以通过 Prometheus 配置文件中的 <code>scrape_config</code> 部分进行配置，Prometheus 会不断更新动态的抓取目标列表，自动停止抓取旧的实例，开始抓取新的实例，Prometheus 特别适合运行于 Kubernetes 集群下面，可以自动发现监控目标。</p><p>此外大部分服务发现机制还会提供目标的一些元数据，通常都是带有 <code>__</code> 的前缀， 比如标签、注解、服务名等等，可以在 relabeling 阶段使用这些元数据来过滤修改目标，这些元信息标签在重新标记阶段后被删除。</p><h1 id="三、基于文件的服务发现" tabindex="-1"><a class="header-anchor" href="#三、基于文件的服务发现"><span>三、基于文件的服务发现</span></a></h1><p>除了基于 Consul 的服务发现之外，Prometheus 也允许我们进行自定义的发现集成，可以通过 watch 一组本地文件来获取抓取目标以及标签信息，也就是我们常说的基于文件的服务发现方式。</p><figure><img src="'+l+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>基于文件的服务发现提供了一种更通用的方式来配置静态目标，并作为一个接口插入自定义服务发现机制。</p><p>它读取一组包含零个或多个 <code>&lt;static_config&gt;</code> 列表的文件，对所有定义的文件的变更通过磁盘监视被检测到并立即应用，文件可以以 YAML 或 JSON 格式提供。文件必须包含一个静态配置的列表:</p><p>当然该文件也可以使用 JSON 格式进行配置：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>[</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    &quot;targets&quot;: [ &quot;&lt;host&gt;&quot;, ... ],</span></span>
<span class="line"><span>    &quot;labels&quot;: {</span></span>
<span class="line"><span>      &quot;&lt;labelname&gt;&quot;: &quot;&lt;labelvalue&gt;&quot;, ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  },</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果是 YAML 文件则格式为：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>- targets:</span></span>
<span class="line"><span>  [ - &#39;&lt;host&gt;&#39; ]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    [ &lt;labelname&gt;: &lt;labelvalue&gt; ... ]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>文件内容也会在指定的刷新间隔时间内定期重新读取。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># Patterns for files from which target groups are extracted.</span></span>
<span class="line"><span>files:</span></span>
<span class="line"><span>  [ - &lt;filename_pattern&gt; ... ]</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Refresh interval to re-read the files.</span></span>
<span class="line"><span>[ refresh_interval: &lt;duration&gt; | default = 5m ]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中 <code>&lt;filename*pattern&gt;</code> 可以是一个以 <code>.json</code>、<code>.yml</code> 或 <code>.yaml</code> 结尾的路径，最后一个路径段可以包含一个匹配任何字符序列的 <code>*</code>，例如：<code>my/path/tg_*.json</code>。</p><h2 id="_1、创建文件" tabindex="-1"><a class="header-anchor" href="#_1、创建文件"><span>1、创建文件</span></a></h2><p>接下来我们来创建一个用于服务发现的目标文件，在与 <code>prometheus.yml</code> 文件相同目录下面创建一个名为 <code>targets.yml</code> 的文件，内容如下所示：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cd /data/docker-prometheus</span></span>
<span class="line"><span>mkdir prometheus/targets</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cat &gt; prometheus/targets/targets.yml&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>- targets: [&#39;localhost:9090&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    job: prometheus</span></span>
<span class="line"><span>- targets: [&#39;cadvisor:8080&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    instance: Prometheus服务器 </span></span>
<span class="line"><span>    job: cadvisor</span></span>
<span class="line"><span>- targets: [&#39;192.168.11.62:8080&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    instance: test服务器 </span></span>
<span class="line"><span>    job: cadvisor</span></span>
<span class="line"><span>- targets: [&#39;node_exporter:9100&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    instance: Prometheus服务器 </span></span>
<span class="line"><span>    job: node-exporter</span></span>
<span class="line"><span>- targets: [&#39;192.168.11.62:9100&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    instance: test服务器 </span></span>
<span class="line"><span>    job: node-exporter</span></span>
<span class="line"><span>- targets: [&#39;192.168.11.62:9113&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    instance: test服务器</span></span>
<span class="line"><span>    job: nginx_exporter</span></span>
<span class="line"><span>- targets: [&#39;192.168.11.62:9121&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    instance: test服务器</span></span>
<span class="line"><span>    job: redis_exporter</span></span>
<span class="line"><span>- targets: [&#39;192.168.11.62:9419&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    instance: test服务器</span></span>
<span class="line"><span>    job: rabitmq_exporter</span></span>
<span class="line"><span>- targets: [&#39;192.168.11.62:9216&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    instance: test服务器</span></span>
<span class="line"><span>    job: mongodb_exporter</span></span>
<span class="line"><span>- targets: [&#39;192.168.11.62:9104&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    instance: test服务器</span></span>
<span class="line"><span>    job: mysqld_exporter</span></span>
<span class="line"><span>- targets: [&#39;192.168.11.62:9256&#39;]</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    instance: test服务器</span></span>
<span class="line"><span>    job: process    </span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>springboot.yml</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt;prometheus/targets/springboot.yml&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>- targets:</span></span>
<span class="line"><span>  - 192.168.11.62:8081</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>blackbox-exporter-http.yml</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt;prometheus/targets/blackbox-exporter-http.yml&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>- targets: </span></span>
<span class="line"><span>  - https://www.baidu.com</span></span>
<span class="line"><span>  - https://www.jd.com</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>blackbox-exporter-tcp.yml</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt;prometheus/targets/blackbox-exporter-tcp.yml&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>- targets:</span></span>
<span class="line"><span>  - 192.168.11.61:22</span></span>
<span class="line"><span>  - 192.168.11.61:9090</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>blackbox-exporter-icmp.yml</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt;prometheus/targets/blackbox-exporter-icmp.yml&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>- targets:</span></span>
<span class="line"><span>  - 192.168.11.61</span></span>
<span class="line"><span>  - 192.168.11.62</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>domain.yml</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt;prometheus/targets/domain.yml&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>- targets:</span></span>
<span class="line"><span>  - qq.com</span></span>
<span class="line"><span>  - baidu.com</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2、配置文件服务发现" tabindex="-1"><a class="header-anchor" href="#_2、配置文件服务发现"><span>2、配置文件服务发现</span></a></h2><p>用于发现的目标文件创建完成后，要让 Prometheus 能够从上面的 <code>targets.yml</code> 文件中自动读取抓取目标，需要在 <code>prometheus.yml</code> 配置文件中的 <code>scrape_configs</code> 部分添加如下所示的抓取配置：</p><p>备份文件</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cp -a prometheus/prometheus.yml{,.bak}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ls -l promethues/prometheus.yml.bak</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用cat新建文件</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt;prometheus/prometheus.yml&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 全局配置</span></span>
<span class="line"><span>global:</span></span>
<span class="line"><span>  scrape_interval:     15s # 将搜刮间隔设置为每15秒一次。默认是每1分钟一次。</span></span>
<span class="line"><span>  evaluation_interval: 15s # 每15秒评估一次规则。默认是每1分钟一次。</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Alertmanager 配置</span></span>
<span class="line"><span>alerting:</span></span>
<span class="line"><span>  alertmanagers:</span></span>
<span class="line"><span>  - static_configs:</span></span>
<span class="line"><span>    - targets: [&#39;alertmanager:9093&#39;]</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 报警(触发器)配置</span></span>
<span class="line"><span>rule_files:</span></span>
<span class="line"><span>  - &quot;alert.yml&quot;</span></span>
<span class="line"><span>  - &quot;rules/*.yml&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 搜刮配置</span></span>
<span class="line"><span>scrape_configs:</span></span>
<span class="line"><span>  - job_name: &quot;file-sd-test&quot;</span></span>
<span class="line"><span>    file_sd_configs:</span></span>
<span class="line"><span>    - refresh_interval: 10s</span></span>
<span class="line"><span>      files:</span></span>
<span class="line"><span>      - &quot;targets/targets.yml&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#  Spring Boot 2.x 应用数据采集配置</span></span>
<span class="line"><span>  - job_name: &#39;file-springboot-demo&#39;</span></span>
<span class="line"><span>    metrics_path: &#39;/actuator/prometheus&#39;</span></span>
<span class="line"><span>    file_sd_configs:</span></span>
<span class="line"><span>    - refresh_interval: 10s</span></span>
<span class="line"><span>      files:</span></span>
<span class="line"><span>      - targets/springboot.yml</span></span>
<span class="line"><span>#http配置</span></span>
<span class="line"><span>  - job_name: &quot;file-blackbox_http&quot;</span></span>
<span class="line"><span>    metrics_path: /probe</span></span>
<span class="line"><span>    params:</span></span>
<span class="line"><span>      module: [http_2xx]</span></span>
<span class="line"><span>    file_sd_configs:</span></span>
<span class="line"><span>    - refresh_interval: 10s</span></span>
<span class="line"><span>      files:</span></span>
<span class="line"><span>      - targets/blackbox-exporter-http.yml</span></span>
<span class="line"><span>    relabel_configs:</span></span>
<span class="line"><span>      - source_labels: [__address__]</span></span>
<span class="line"><span>        target_label: __param_target</span></span>
<span class="line"><span>      - source_labels: [__param_target]</span></span>
<span class="line"><span>        target_label: instance</span></span>
<span class="line"><span>      - target_label: __address__</span></span>
<span class="line"><span>        replacement: 192.168.11.62:9115</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#tcp检查配置</span></span>
<span class="line"><span>  - job_name: &quot;file-blackbox_tcp&quot;</span></span>
<span class="line"><span>    metrics_path: /probe</span></span>
<span class="line"><span>    params:</span></span>
<span class="line"><span>      module: [tcp_connect]</span></span>
<span class="line"><span>    file_sd_configs:</span></span>
<span class="line"><span>    - refresh_interval: 10s</span></span>
<span class="line"><span>      files:</span></span>
<span class="line"><span>      - targets/blackbox-exporter-tcp.yml</span></span>
<span class="line"><span>    relabel_configs:</span></span>
<span class="line"><span>      - source_labels: [__address__]</span></span>
<span class="line"><span>        target_label: __param_target</span></span>
<span class="line"><span>      - source_labels: [__param_target]</span></span>
<span class="line"><span>        target_label: instance</span></span>
<span class="line"><span>      - target_label: __address__</span></span>
<span class="line"><span>        replacement: 192.168.11.62:9115</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#icmp检查配置 ping</span></span>
<span class="line"><span>  - job_name: &quot;blackbox_icmp&quot;</span></span>
<span class="line"><span>    metrics_path: /probe</span></span>
<span class="line"><span>    params:</span></span>
<span class="line"><span>      module: [icmp]</span></span>
<span class="line"><span>    file_sd_configs:</span></span>
<span class="line"><span>    - refresh_interval: 10s</span></span>
<span class="line"><span>      files:</span></span>
<span class="line"><span>      - targets/blackbox-exporter-http.yml</span></span>
<span class="line"><span>    relabel_configs:</span></span>
<span class="line"><span>      - source_labels: [__address__]</span></span>
<span class="line"><span>        target_label: __param_target</span></span>
<span class="line"><span>      - source_labels: [__param_target]</span></span>
<span class="line"><span>        target_label: instance</span></span>
<span class="line"><span>      - target_label: __address__</span></span>
<span class="line"><span>        replacement: 192.168.11.62:9115</span></span>
<span class="line"><span>  - job_name: domain</span></span>
<span class="line"><span>    #scrape_interval: 1h</span></span>
<span class="line"><span>    scrape_interval: 15s</span></span>
<span class="line"><span>    metrics_path: /probe</span></span>
<span class="line"><span>    relabel_configs:</span></span>
<span class="line"><span>      - source_labels: [__address__]</span></span>
<span class="line"><span>        target_label: __param_target</span></span>
<span class="line"><span>      - target_label: __address__</span></span>
<span class="line"><span>        replacement: 192.168.11.62:9222 # domain_exporter address</span></span>
<span class="line"><span>    file_sd_configs:</span></span>
<span class="line"><span>    - refresh_interval: 10s</span></span>
<span class="line"><span>      files:</span></span>
<span class="line"><span>      - targets/domain.yml</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重载</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>curl -X POST http://localhost:9090/-/reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>重新 reload 或者重启下 Prometheus 让其重新读取配置文件信息，然后同样前往 Prometheus UI 的 <code>targets</code> 页面下面查看</p><figure><img src="`+p+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>然后我们可以尝试改变 <code>targets.yml</code> 的内容，比如为<code>192.168.11.62:8080</code>实例增加一个 env: test的标签，不用重新加载 Prometheus 配置，Prometheus 将 watch 该文件，并自动接收任何变化。</p><p>注意：当在生产环境 Prometheus 服务器中改变 <code>file_sd</code> 目标文件时，确保改变是原子的，以避免重新加载出现错误，最好的方法是在一个单独的位置创建更新的文件，然后将其重命名为目标文件名（使用 <code>mv</code> 命令或 <code>rename()</code> 系统调用）。</p><figure><img src="'+d+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这样我们就完成了基于文件的通用服务发现机制，可以让我们动态地改变 Prometheus 的监控目标，而不需要重新启动或重新加载 Prometheus 服务。</p>',48),c=[r];function v(o,m){return a(),n("div",null,c)}const h=s(t,[["render",v],["__file","3.1.服务发现_基于文件的服务发现.html.vue"]]),g=JSON.parse('{"path":"/note/Prometheus/3.1.%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0_%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.html","title":"3.1.服务发现&基于文件的服务发现","lang":"zh-CN","frontmatter":{"title":"3.1.服务发现&基于文件的服务发现","order":21,"icon":"lightbulb","description":"一、环境 二、服务发现 接下来我们将学习 Prometheus 中是如何使用服务发现来查找和抓取目标的。我们知道在 Prometheus 配置文件中可以通过一个 static_configs 来配置静态的抓取任务，但是在云环境下，特别是容器环境下，抓取目标地址是经常变动的，所以用静态的方式就不能满足这些场景了，还有特别在很多服务器需要监控时。所以我们需...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/note/Prometheus/3.1.%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0_%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.html"}],["meta",{"property":"og:site_name","content":"风华"}],["meta",{"property":"og:title","content":"3.1.服务发现&基于文件的服务发现"}],["meta",{"property":"og:description","content":"一、环境 二、服务发现 接下来我们将学习 Prometheus 中是如何使用服务发现来查找和抓取目标的。我们知道在 Prometheus 配置文件中可以通过一个 static_configs 来配置静态的抓取任务，但是在云环境下，特别是容器环境下，抓取目标地址是经常变动的，所以用静态的方式就不能满足这些场景了，还有特别在很多服务器需要监控时。所以我们需..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"风华"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"3.1.服务发现&基于文件的服务发现\\",\\"image\\":[\\"\\"],\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"风华\\",\\"url\\":\\"/portfolio\\"}]}"]]},"headers":[{"level":2,"title":"1、创建文件","slug":"_1、创建文件","link":"#_1、创建文件","children":[]},{"level":2,"title":"2、配置文件服务发现","slug":"_2、配置文件服务发现","link":"#_2、配置文件服务发现","children":[]}],"git":{},"readingTime":{"minutes":6.62,"words":1986},"filePathRelative":"note/Prometheus/3.1.服务发现&基于文件的服务发现.md","autoDesc":true}');export{h as comp,g as data};
