import{_ as e}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,o as s,d as n}from"./app-DZWWIkr0.js";const i="/bj/assets/2023-10-28_210308_2150290.017798607968914526-b03JT58a.png",l="/bj/assets/2023-10-28_210308_6734940.9404917686925496-DEWlZCr3.png",t="/bj/assets/2023-10-28_210309_3760350.8868156115790827-D_bN2xt4.png",p="/bj/assets/2023-10-28_210308_3528440.4148360071737627-DyYfrN_5.png",r="/bj/assets/2023-10-28_210308_8201440.5962978908654817-CJ-1XtM5.png",d="/bj/assets/2023-10-28_210308_9754380.04707546694154563-BflGb6z8.png",c={},o=n('<h1 id="一、环境介绍" tabindex="-1"><a class="header-anchor" href="#一、环境介绍"><span>一、环境介绍</span></a></h1><table id="a04f6509" class="ne-table" style="table-layout:fixed;border-collapse:collapse;border:1px solid #d9d9d9;width:748px;"><tbody><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="u2e580bce" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">主机名</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u615d2408" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">IP地址</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ub51c88a4" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">系统</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u6e48106b" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">说明</span></p></td></tr><tr style="height:33px;"><td width="187" style="border:1px solid #d9d9d9;"><p id="u150d077f" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">localhost</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u98981a59" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">192.168.11.61</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="u3d203e62" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">Ubuntu 20.04</span></p></td><td width="187" style="border:1px solid #d9d9d9;"><p id="ue35265c9" class="ne-p" style="margin:0;padding:0;min-height:24px;"><span class="ne-text">docker方式安装的prometheus</span></p></td></tr></tbody></table><h1 id="二、使用企业微信报警" tabindex="-1"><a class="header-anchor" href="#二、使用企业微信报警"><span>二、使用企业微信报警</span></a></h1><h2 id="_1、注册企业微信" tabindex="-1"><a class="header-anchor" href="#_1、注册企业微信"><span>1、注册企业微信</span></a></h2><p>浏览器打开https://work.weixin.qq.com/ 点击注册</p><p>如下填写资料：</p><figure><img src="'+i+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_2、webhook告警-和微信应用告警二选一" tabindex="-1"><a class="header-anchor" href="#_2、webhook告警-和微信应用告警二选一"><span>2、webhook告警（和微信应用告警二选一）</span></a></h2><ul><li>注：请换成PrometheusAlert方式</li></ul><h3 id="添加群机器人" tabindex="-1"><a class="header-anchor" href="#添加群机器人"><span>添加群机器人</span></a></h3><p>注册成功后，手机下载企业微信，登陆企业微信。</p><p>在手机上，如下图操作：</p><p>注：因为我这个是测试企业微信，所以就在”企业全员群“，新建群机器人了。真实一般都是新创建个部门，然后把需要接受报警的人拉到这个部门里面，然后在这个部门群里面新建机器人。</p><figure><img src="'+l+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="复制机器人的webhook地址" tabindex="-1"><a class="header-anchor" href="#复制机器人的webhook地址"><span>复制机器人的webhook地址</span></a></h3><p>我在上图复制的到webhook地址如下：</p><p>真实只需要用到key后面的</p><h3 id="二进制安装alertmanager-wechatrobot-webhook" tabindex="-1"><a class="header-anchor" href="#二进制安装alertmanager-wechatrobot-webhook"><span>二进制安装alertmanager-wechatrobot-webhook</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cd /opt/prometheus/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#下载代码</span></span>
<span class="line"><span>git clone https://gitee.com/linge365/alertmanager-wechatrobot-webhook.git</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#进入目录</span></span>
<span class="line"><span>cd alertmanager-wechatrobot-webhook</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#把service服务移动到对应目录下</span></span>
<span class="line"><span>mv alertmanager-wechatrobot-webhook.service /etc/systemd/system/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#添加prometheus用户，如果已存在不需要重复添加</span></span>
<span class="line"><span>useradd -M -s /usr/sbin/nologin prometheus</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#授权</span></span>
<span class="line"><span>chown -R prometheu.prometheus /opt/prometheus</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>systemctl start alertmanager-wechatrobot-webhook</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>启动成功后，如下图：</p><figure><img src="`+t+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>检查端口</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>ss -lntp|grep 8999</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="修改alertmanager配置" tabindex="-1"><a class="header-anchor" href="#修改alertmanager配置"><span>修改alertmanager配置</span></a></h3><p>192.168.11.60根据时间修改，192.168.11.60为安装alertmanager-wechatrobot-webhook的服务器ip。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim alertmanager/config.yml </span></span>
<span class="line"><span>#增加如下配置</span></span>
<span class="line"><span>route:</span></span>
<span class="line"><span>  receiver: wechat</span></span>
<span class="line"><span></span></span>
<span class="line"><span>receivers:</span></span>
<span class="line"><span>- name: &quot;wechat&quot;</span></span>
<span class="line"><span>  webhook_configs:</span></span>
<span class="line"><span>  - url: &#39;http://192.168.11.60:8999/webhook?key=之前复制的企业微信webhook的key&#39;</span></span>
<span class="line"><span>    send_resolved: true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>检查配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#docker安装方式，检查</span></span>
<span class="line"><span>docker exec -it alertmanager  amtool check-config /etc/alertmanager/config.yml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#二进制安装方式，检查</span></span>
<span class="line"><span>/opt/alertmanager/alertmanager  amtool check-config /etc/alertmanager/config.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重载alertmanager配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>curl -X POST http://localhost:9093/-/reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_3、微信应用告警-和webhook告警二选一" tabindex="-1"><a class="header-anchor" href="#_3、微信应用告警-和webhook告警二选一"><span>3、微信应用告警（和webhook告警二选一）</span></a></h2><ul><li>企业微信应用需要添加ip白名单才能正常使用</li></ul><h3 id="浏览器打开企业微信" tabindex="-1"><a class="header-anchor" href="#浏览器打开企业微信"><span>浏览器打开企业微信</span></a></h3><p><a href="https://work.weixin.qq.com/" target="_blank" rel="noopener noreferrer">企业微信官网</a></p><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440307-f06fdad3-9bf6-46ee-bce3-3b8b1ba93dfc.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>手机下载“企业微信”，使用注册的手机登录。扫描二维码登录企业微信官网</p><figure><img src="`+p+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>短信验证</p><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194439950-a6acbe91-4664-46b7-b0c8-6d041d85b4f2.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_40%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="创建应用" tabindex="-1"><a class="header-anchor" href="#创建应用"><span>创建应用</span></a></h3><p>登录成功后，选择应用管理--创建应用</p><figure><img src="'+r+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>上传logo，填写应用名称，选择可见范围</p><figure><img src="'+d+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="获取agentid" tabindex="-1"><a class="header-anchor" href="#获取agentid"><span>获取AgentID</span></a></h3><p>创建应用成功后，复制AgentId,和查看Secret--会发送Secret到手机企业微信中。</p><p>1000002</p><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440000-28082e59-1f8d-434a-9e98-b636df871135.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="设置ip白名单" tabindex="-1"><a class="header-anchor" href="#设置ip白名单"><span>设置ip白名单</span></a></h3><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194439997-41496686-91b2-47b2-b986-31916dcd4917.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_54%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="设置可信域名" tabindex="-1"><a class="header-anchor" href="#设置可信域名"><span>设置可信域名</span></a></h3><p>xxx.com只是举例，这个域名要根据真实的域名修改。</p><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194439990-a55b89c6-b1d9-4f7c-bd50-c21dbd1a2472.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_35%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>设置ip白名单</p><h3 id="获取secret" tabindex="-1"><a class="header-anchor" href="#获取secret"><span>获取Secret</span></a></h3><p>手机下载“企业微信”app，并登录成功。”企业微信团队“发来一条新消息，点击查看Secret，复制Secret</p><p>-rg8Xtzchefy6w94O6G_qT5gOMhDZt7MsZmHSELAOZw</p><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440150-e3340673-5ce8-4fc3-9767-3b00161dffe4.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_32%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="获取部门id" tabindex="-1"><a class="header-anchor" href="#获取部门id"><span>获取部门id</span></a></h3><p>1</p><p>注：获取用户名或者创建标签都可以</p><p>点击通讯录--选择企业名--点右边--查看部门id，如下图：</p><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440004-dd3da1da-b20e-4d41-aff2-b962c14fc3b3.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="获取corp-id" tabindex="-1"><a class="header-anchor" href="#获取corp-id"><span>获取corp_id</span></a></h3><p>点击“我的企业”--复制企业id.ww75c7ff0bc812538c</p><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440054-d13c983b-05e9-457a-b08e-a0cfc1fe4542.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="修改alertmanager配置-1" tabindex="-1"><a class="header-anchor" href="#修改alertmanager配置-1"><span>修改alertmanager配置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim alertmanager/config.yml </span></span>
<span class="line"><span></span></span>
<span class="line"><span>route:</span></span>
<span class="line"><span>  receiver: wechat</span></span>
<span class="line"><span></span></span>
<span class="line"><span>receivers:</span></span>
<span class="line"><span>- name: &#39;wechat&#39;</span></span>
<span class="line"><span>  wechat_configs:</span></span>
<span class="line"><span>  - send_resolved: true</span></span>
<span class="line"><span>    #to_user: &#39;@all&#39;		 #发送给企业微信用户的ID，@all是所有人</span></span>
<span class="line"><span>    #to_tag: &#39;1&#39;         #企业微信中创建的接收告警的标签</span></span>
<span class="line"><span>    to_party: &#39;1&#39;        #部门id</span></span>
<span class="line"><span>    agent_id: &#39;1000002&#39;     # 企业微信中创建的应用的ID</span></span>
<span class="line"><span>    corp_id: &#39;ww75c7ff0bc812538c&#39;      # 企业微信中企业ID</span></span>
<span class="line"><span>    api_secret: &#39;-rg8Xtzchefy6w94O6G_qT5gOMhDZt7MsZmHSELAOZw&#39;      # 企业微信中，应用的Secret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="检查配置" tabindex="-1"><a class="header-anchor" href="#检查配置"><span>检查配置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#docker安装方式，检查</span></span>
<span class="line"><span>docker exec -it alertmanager  amtool check-config /etc/alertmanager/config.yml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#二进制安装方式，检查</span></span>
<span class="line"><span>/opt/alertmanager/alertmanager  amtool check-config /etc/alertmanager/config.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="重载alertmanager配置" tabindex="-1"><a class="header-anchor" href="#重载alertmanager配置"><span>重载alertmanager配置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>curl -X POST http://localhost:9093/-/reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_4、测试" tabindex="-1"><a class="header-anchor" href="#_4、测试"><span>4、测试</span></a></h2><p>关闭node-exporter</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#docker环境</span></span>
<span class="line"><span>docker stop node-exporter</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#二进制安装环境</span></span>
<span class="line"><span>systemctl stop node_exporter</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看prometheus的alerts: <a href="http://192.168.11.61:9090/alerts" target="_blank" rel="noopener noreferrer">http://192.168.11.61:9090/alerts</a></p><p>查看alertmanager的alerts：<a href="http://192.168.11.61:9093/#/alerts" target="_blank" rel="noopener noreferrer">http://192.168.11.61:9093/#/alerts</a></p><p>如果没收到钉钉消息，排查</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>docker logs -f alertmanager</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>微信正常收到报警信息如下图：</p><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440254-3affc3fe-7ce6-4e0e-92d6-62903d7bfcb8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_41%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="四、使用模版-非必需-仅限微信应用告警" tabindex="-1"><a class="header-anchor" href="#四、使用模版-非必需-仅限微信应用告警"><span>四、使用模版(非必需，仅限微信应用告警)</span></a></h1><ul><li>看需求--不使用模版默认也行，不适用webhook方式告警。</li></ul><h2 id="_1、创建模版文件-prometheus服务器操作" tabindex="-1"><a class="header-anchor" href="#_1、创建模版文件-prometheus服务器操作"><span>1、创建模版文件（prometheus服务器操作）</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cd /data/docker-prometheus</span></span>
<span class="line"><span> </span></span>
<span class="line"><span>#创建存放模版的目录</span></span>
<span class="line"><span>mkdir alertmanager/template</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过cat创建</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt; alertmanager/template/wechat.tmpl &lt;&lt;&quot;EOF&quot; </span></span>
<span class="line"><span>{{ define &quot;wechat.html&quot; }}</span></span>
<span class="line"><span>{{- if gt (len .Alerts.Firing) 0 -}}{{ range .Alerts }}</span></span>
<span class="line"><span>@告警通知</span></span>
<span class="line"><span>告警程序: prometheus_alert</span></span>
<span class="line"><span>告警级别: {{ .Labels.severity }}级别</span></span>
<span class="line"><span>告警类型: {{ .Labels.alertname }}</span></span>
<span class="line"><span>故障主机: {{ .Labels.instance }}</span></span>
<span class="line"><span>告警主题: {{ .Annotations.summary }}</span></span>
<span class="line"><span>告警详情: {{ .Annotations.description }}</span></span>
<span class="line"><span>触发时间: {{ .StartsAt.Local.Format &quot;2006-01-02 15:04:05&quot; }}</span></span>
<span class="line"><span>{{ end }}{{ end -}}</span></span>
<span class="line"><span>{{- if gt (len .Alerts.Resolved) 0 -}}{{ range .Alerts }}</span></span>
<span class="line"><span>@告警恢复</span></span>
<span class="line"><span>告警程序: prometheus_alert</span></span>
<span class="line"><span>故障主机: {{ .Labels.instance }}</span></span>
<span class="line"><span>故障主题: {{ .Annotations.summary }}</span></span>
<span class="line"><span>告警详情: {{ .Annotations.description }}</span></span>
<span class="line"><span>告警时间: {{ .StartsAt.Local.Format &quot;2006-01-02 15:04:05&quot; }}</span></span>
<span class="line"><span>恢复时间: {{ .EndsAt.Local.Format &quot;2006-01-02 15:04:05&quot; }}</span></span>
<span class="line"><span>{{ end }}{{ end -}}</span></span>
<span class="line"><span>{{- end }}</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>检查</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim alertmanager/template/wechat.tmpl</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_2、修改alertmanager配置" tabindex="-1"><a class="header-anchor" href="#_2、修改alertmanager配置"><span>2、修改alertmanager配置</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>vim alertmanager/config.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>增加message这行</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#模版配置</span></span>
<span class="line"><span>templates:</span></span>
<span class="line"><span>  - &#39;/etc/alertmanager/template/*.tmpl&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>....</span></span>
<span class="line"><span></span></span>
<span class="line"><span>receivers:</span></span>
<span class="line"><span>- name: &#39;wechat&#39;</span></span>
<span class="line"><span>  wechat_configs:</span></span>
<span class="line"><span>  - send_resolved: true</span></span>
<span class="line"><span>    #只增加这行配置</span></span>
<span class="line"><span>    message: &#39;{{ template &quot;wechat.html&quot; . }}&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重载配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>curl -X POST http://localhost:9093/-/reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>检查</p><p><a href="http://192.168.11.61:9093/#/status" target="_blank" rel="noopener noreferrer">http://192.168.11.61:9093/#/status</a></p><h2 id="_3、测试" tabindex="-1"><a class="header-anchor" href="#_3、测试"><span>3、测试</span></a></h2><p>企业微信应用报警，修改前和修改后的区别如下图：</p><h1 id="四、我的微信" tabindex="-1"><a class="header-anchor" href="#四、我的微信"><span>四、我的微信</span></a></h1><p>如果碰到问题，可以随时加我微信，谢谢</p><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440114-a8078369-32f5-4586-8812-0a8e4f2fa7b5.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_31%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,104),h=[o];function g(m,b){return s(),a("div",null,h)}const k=e(c,[["render",g],["__file","5.5.企业微信告警.html.vue"]]),_=JSON.parse('{"path":"/note/Prometheus/5.5.%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6.html","title":"5.5.企业微信告警","lang":"zh-CN","frontmatter":{"title":"5.5.企业微信告警","order":31,"icon":"lightbulb","description":"一、环境介绍 二、使用企业微信报警 1、注册企业微信 浏览器打开https://work.weixin.qq.com/ 点击注册 如下填写资料： 2、webhook告警（和微信应用告警二选一） 注：请换成PrometheusAlert方式 添加群机器人 注册成功后，手机下载企业微信，登陆企业微信。 在手机上，如下图操作： 注：因为我这个是测试企业微信，...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/bj/note/Prometheus/5.5.%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6.html"}],["meta",{"property":"og:site_name","content":"风华"}],["meta",{"property":"og:title","content":"5.5.企业微信告警"}],["meta",{"property":"og:description","content":"一、环境介绍 二、使用企业微信报警 1、注册企业微信 浏览器打开https://work.weixin.qq.com/ 点击注册 如下填写资料： 2、webhook告警（和微信应用告警二选一） 注：请换成PrometheusAlert方式 添加群机器人 注册成功后，手机下载企业微信，登陆企业微信。 在手机上，如下图操作： 注：因为我这个是测试企业微信，..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440307-f06fdad3-9bf6-46ee-bce3-3b8b1ba93dfc.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"风华"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"5.5.企业微信告警\\",\\"image\\":[\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440307-f06fdad3-9bf6-46ee-bce3-3b8b1ba93dfc.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\",\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194439950-a6acbe91-4664-46b7-b0c8-6d041d85b4f2.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_40%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\",\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440000-28082e59-1f8d-434a-9e98-b636df871135.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\",\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194439997-41496686-91b2-47b2-b986-31916dcd4917.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_54%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\",\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194439990-a55b89c6-b1d9-4f7c-bd50-c21dbd1a2472.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_35%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\",\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440150-e3340673-5ce8-4fc3-9767-3b00161dffe4.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_32%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\",\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440004-dd3da1da-b20e-4d41-aff2-b962c14fc3b3.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\",\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440054-d13c983b-05e9-457a-b08e-a0cfc1fe4542.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\",\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440254-3affc3fe-7ce6-4e0e-92d6-62903d7bfcb8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_41%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\",\\"https://cdn.nlark.com/yuque/0/2023/png/22475872/1688194440114-a8078369-32f5-4586-8812-0a8e4f2fa7b5.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_31%2Ctext_5p6X5ZOlTGludXg%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10\\"],\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"风华\\",\\"url\\":\\"/portfolio\\"}]}"]]},"headers":[{"level":2,"title":"1、注册企业微信","slug":"_1、注册企业微信","link":"#_1、注册企业微信","children":[]},{"level":2,"title":"2、webhook告警（和微信应用告警二选一）","slug":"_2、webhook告警-和微信应用告警二选一","link":"#_2、webhook告警-和微信应用告警二选一","children":[{"level":3,"title":"添加群机器人","slug":"添加群机器人","link":"#添加群机器人","children":[]},{"level":3,"title":"复制机器人的webhook地址","slug":"复制机器人的webhook地址","link":"#复制机器人的webhook地址","children":[]},{"level":3,"title":"二进制安装alertmanager-wechatrobot-webhook","slug":"二进制安装alertmanager-wechatrobot-webhook","link":"#二进制安装alertmanager-wechatrobot-webhook","children":[]},{"level":3,"title":"修改alertmanager配置","slug":"修改alertmanager配置","link":"#修改alertmanager配置","children":[]}]},{"level":2,"title":"3、微信应用告警（和webhook告警二选一）","slug":"_3、微信应用告警-和webhook告警二选一","link":"#_3、微信应用告警-和webhook告警二选一","children":[{"level":3,"title":"浏览器打开企业微信","slug":"浏览器打开企业微信","link":"#浏览器打开企业微信","children":[]},{"level":3,"title":"创建应用","slug":"创建应用","link":"#创建应用","children":[]},{"level":3,"title":"获取AgentID","slug":"获取agentid","link":"#获取agentid","children":[]},{"level":3,"title":"设置ip白名单","slug":"设置ip白名单","link":"#设置ip白名单","children":[]},{"level":3,"title":"设置可信域名","slug":"设置可信域名","link":"#设置可信域名","children":[]},{"level":3,"title":"获取Secret","slug":"获取secret","link":"#获取secret","children":[]},{"level":3,"title":"获取部门id","slug":"获取部门id","link":"#获取部门id","children":[]},{"level":3,"title":"获取corp_id","slug":"获取corp-id","link":"#获取corp-id","children":[]},{"level":3,"title":"修改alertmanager配置","slug":"修改alertmanager配置-1","link":"#修改alertmanager配置-1","children":[]},{"level":3,"title":"检查配置","slug":"检查配置","link":"#检查配置","children":[]},{"level":3,"title":"重载alertmanager配置","slug":"重载alertmanager配置","link":"#重载alertmanager配置","children":[]}]},{"level":2,"title":"4、测试","slug":"_4、测试","link":"#_4、测试","children":[]},{"level":2,"title":"1、创建模版文件（prometheus服务器操作）","slug":"_1、创建模版文件-prometheus服务器操作","link":"#_1、创建模版文件-prometheus服务器操作","children":[]},{"level":2,"title":"2、修改alertmanager配置","slug":"_2、修改alertmanager配置","link":"#_2、修改alertmanager配置","children":[]},{"level":2,"title":"3、测试","slug":"_3、测试","link":"#_3、测试","children":[]}],"git":{},"readingTime":{"minutes":5.75,"words":1726},"filePathRelative":"note/Prometheus/5.5.企业微信告警.md","autoDesc":true}');export{k as comp,_ as data};
