<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.13" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.49" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/vuepress/note/kubernetes/install/kubeadm/High%20availability/01.html"><meta property="og:site_name" content="风华"><meta property="og:title" content="01-部署3主3从的高可用集群"><meta property="og:description" content="部署3主3从的kubernetes1.21.0高可用集群环境 参考地址：https://www.cnblogs.com/superlinux/p/14676959.html 1、主机操作系统说明 2、主机硬件配置说明 花里胡哨的美化配置 3、主机配置 3.1、配置yum源，所有主机都配置 采用阿里云源 下载安装所有的源码文件，后面需要用到 3.2、修改..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="风华"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"01-部署3主3从的高可用集群","image":[""],"dateModified":null,"author":[{"@type":"Person","name":"风华","url":"/portfolio"}]}</script><title>01-部署3主3从的高可用集群 | 风华</title><meta name="description" content="部署3主3从的kubernetes1.21.0高可用集群环境 参考地址：https://www.cnblogs.com/superlinux/p/14676959.html 1、主机操作系统说明 2、主机硬件配置说明 花里胡哨的美化配置 3、主机配置 3.1、配置yum源，所有主机都配置 采用阿里云源 下载安装所有的源码文件，后面需要用到 3.2、修改...">
    <link rel="preload" href="/vuepress/assets/style-BN9f9jJ0.css" as="style"><link rel="stylesheet" href="/vuepress/assets/style-BN9f9jJ0.css">
    <link rel="modulepreload" href="/vuepress/assets/app-DuswJAHG.js"><link rel="modulepreload" href="/vuepress/assets/01.html-B1eX4Qpe.js"><link rel="modulepreload" href="/vuepress/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/vuepress/assets/index.html-GePCzIop.js" as="script"><link rel="prefetch" href="/vuepress/assets/portfolio.html-BqSMPslJ.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-DHr1_Z50.js" as="script"><link rel="prefetch" href="/vuepress/assets/disable.html-D6falmFF.js" as="script"><link rel="prefetch" href="/vuepress/assets/encrypt.html-CrV9skcX.js" as="script"><link rel="prefetch" href="/vuepress/assets/layout.html-CwlQsAGH.js" as="script"><link rel="prefetch" href="/vuepress/assets/markdown.html-CVk4FTvB.js" as="script"><link rel="prefetch" href="/vuepress/assets/page.html-D3lytjCv.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-D2abXtTg.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-DJl2Jqgc.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-mffaLYUw.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-C3nbI-_t.js" as="script"><link rel="prefetch" href="/vuepress/assets/baz.html-NLWBnDLq.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-DNHeL1DQ.js" as="script"><link rel="prefetch" href="/vuepress/assets/ray.html-7g5yIBAX.js" as="script"><link rel="prefetch" href="/vuepress/assets/1.1.安装vmware及vmware安装ubuntu.html-C0QW_9Lu.js" as="script"><link rel="prefetch" href="/vuepress/assets/1.2.安装Xshell7和使用Xshell远程连接ubuntu.html-C93BnKqy.js" as="script"><link rel="prefetch" href="/vuepress/assets/1.3.Prometheus监控介绍.html-COqqBCCa.js" as="script"><link rel="prefetch" href="/vuepress/assets/1.4.二进制安装prometheus.html-DidIWQyM.js" as="script"><link rel="prefetch" href="/vuepress/assets/1.5.docker安装prometheus.html-CvtptZHS.js" as="script"><link rel="prefetch" href="/vuepress/assets/1.6.Prometheus相关概念.html-C1sRBlTj.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.1.Exporter概述.html-CfKcI5Nw.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.10.监控mysql.html-DIZ9XNWk.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.11.监控springboot2.x.html-BDzK0Lds.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.12.进程监控.html-D52KwF9O.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.14.域名过期监控.html-F7Y30e_q.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.15.监控总结.html-D3doIR3F.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.16.pushgateway自定义监控.html-DJKJ4RgE.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.17.监控华为交换机.html-BT9bEo5u.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.2.监控linux服务器.html-BFyIAP30.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.3.监控tengine（新增）.html-eWWq7vq8.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.4.监控nginx.html-Cu6wmbWP.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.6.监控redis.html-CMs-sS_d.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.7.监控rabbitmq.html-C_sCq5_d.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.8.监控mongodb.html-DmCQR8pj.js" as="script"><link rel="prefetch" href="/vuepress/assets/2.9.监控docker.html-DB6Mabwb.js" as="script"><link rel="prefetch" href="/vuepress/assets/3.1.服务发现_基于文件的服务发现.html-DrOoBoH9.js" as="script"><link rel="prefetch" href="/vuepress/assets/3.2.基于 Consul 的服务发现.html-CJuTR2L_.js" as="script"><link rel="prefetch" href="/vuepress/assets/3.3.Relabeling机制.html-CUkOxxR4.js" as="script"><link rel="prefetch" href="/vuepress/assets/4.1.PromQL 基础使用.html-CMRtzd8Q.js" as="script"><link rel="prefetch" href="/vuepress/assets/4.2.PromQL 操作符.html-CT-l5Cpx.js" as="script"><link rel="prefetch" href="/vuepress/assets/4.3.PromQL 内置函数.html-sV5zXSbt.js" as="script"><link rel="prefetch" href="/vuepress/assets/5.1.Prometheus告警简介.html-Dw_JqSd_.js" as="script"><link rel="prefetch" href="/vuepress/assets/5.2.Alertmanager配置概述及告警规则.html-DYpX-EYc.js" as="script"><link rel="prefetch" href="/vuepress/assets/5.3.163邮箱告警.html-Dr-Zt9pp.js" as="script"><link rel="prefetch" href="/vuepress/assets/5.4.企业钉钉告警.html-D4i325PC.js" as="script"><link rel="prefetch" href="/vuepress/assets/5.5.企业微信告警.html-DAgwowPQ.js" as="script"><link rel="prefetch" href="/vuepress/assets/5.6.手机电话、短信告警.html-B0e4OSe4.js" as="script"><link rel="prefetch" href="/vuepress/assets/5.7.PrometheusAlert（新增）.html-MHfSANRr.js" as="script"><link rel="prefetch" href="/vuepress/assets/5.8.Alertmanager抑制、静默、路由、告警分组.html-Bhsl51iL.js" as="script"><link rel="prefetch" href="/vuepress/assets/5.9.告警通知总结.html-D29dmQKh.js" as="script"><link rel="prefetch" href="/vuepress/assets/6.1.Grafana 介绍.html-BY7Z41CB.js" as="script"><link rel="prefetch" href="/vuepress/assets/6.2.Grafana添加时间序列面板.html-DewF_0vq.js" as="script"><link rel="prefetch" href="/vuepress/assets/6.3.Grafana添加表格面板.html-N4tU-fqx.js" as="script"><link rel="prefetch" href="/vuepress/assets/6.4.仪表盘和统计面板.html-BeZqPDzk.js" as="script"><link rel="prefetch" href="/vuepress/assets/6.5.Grafana用户和角色.html-BXdsdF7n.js" as="script"><link rel="prefetch" href="/vuepress/assets/6.6.Grafana告警功能（了解）.html-0m6Id4Ou.js" as="script"><link rel="prefetch" href="/vuepress/assets/7.1.Prometheus和alertmanager高可用.html-Dg-i1ke7.js" as="script"><link rel="prefetch" href="/vuepress/assets/8.1.Prometheus Operator.html-Rx0Hif_X.js" as="script"><link rel="prefetch" href="/vuepress/assets/8.2.k8s集群监控.html-Cj13Nr_L.js" as="script"><link rel="prefetch" href="/vuepress/assets/8.3.etcd监控.html-CGuiBD10.js" as="script"><link rel="prefetch" href="/vuepress/assets/8.4.在k8s中监控redis.html-B-YO4Gpa.js" as="script"><link rel="prefetch" href="/vuepress/assets/8.5.在k8s中监控MySQL.html-tSxwyDEw.js" as="script"><link rel="prefetch" href="/vuepress/assets/8.6.在k8s中黑盒监控.html-pSfUWsO1.js" as="script"><link rel="prefetch" href="/vuepress/assets/8.7.在k8s中使用钉钉，邮件，企业微信接收告警通知.html-CynJRY0A.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-B-2ODyF3.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-oTMDrHJg.js" as="script"><link rel="prefetch" href="/vuepress/assets/01.html-Dpf-81W1.js" as="script"><link rel="prefetch" href="/vuepress/assets/02.html-CQ1Bfyan.js" as="script"><link rel="prefetch" href="/vuepress/assets/03.html-qSHs9mPZ.js" as="script"><link rel="prefetch" href="/vuepress/assets/04.html-T7qvXHGR.js" as="script"><link rel="prefetch" href="/vuepress/assets/05.html-lvRkFsdv.js" as="script"><link rel="prefetch" href="/vuepress/assets/06.html-hEAR0mDE.js" as="script"><link rel="prefetch" href="/vuepress/assets/07.html-f5UIEyXh.js" as="script"><link rel="prefetch" href="/vuepress/assets/08.html-E5ojhVTN.js" as="script"><link rel="prefetch" href="/vuepress/assets/09.html-C6uxcpLN.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-C4CFxOj5.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-Co1ijRoT.js" as="script"><link rel="prefetch" href="/vuepress/assets/01.html-DG41DH27.js" as="script"><link rel="prefetch" href="/vuepress/assets/02.html-CUruRMDF.js" as="script"><link rel="prefetch" href="/vuepress/assets/03.html-DhD5nUeU.js" as="script"><link rel="prefetch" href="/vuepress/assets/04.html-vC6ElDhY.js" as="script"><link rel="prefetch" href="/vuepress/assets/05.html-B4_niDBh.js" as="script"><link rel="prefetch" href="/vuepress/assets/06.html-CgnmHXol.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-TI_wpaPD.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-tatqJlQ1.js" as="script"><link rel="prefetch" href="/vuepress/assets/for嵌套.html-CA81sYly.js" as="script"><link rel="prefetch" href="/vuepress/assets/if语句与shell运算.html-H7SGJmJK.js" as="script"><link rel="prefetch" href="/vuepress/assets/if高级用法.html-BViOnEkV.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell 数组详解.html-0gYIrecm.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell函数.html-D0FmzLXd.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell变量详解.html-vPeczS3D.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell对文件的操作.html-P46rRUog.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell数据筛选与处理.html-8DS4ub-_.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell流程控制-if判断语句.html-BNTF4J2P.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本中常用命令复习.html-CikR8DRX.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本介绍.html-rU5VdZEd.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本实战案例-数据磁盘初始化.html-DjsR9TjV.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本格式化输出.html-4GoRVSAf.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-Python安装脚本.html-B_zl1SWt.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-mysql备份脚本.html-BxCaMeyd.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-nginx安装脚本.html-fKNep67V.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-主机状态监控脚本.html-DYUN9z3r.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-判断服务状态.html-UItq3PuS.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-判断闰年.html-BHKhRvOd.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-监控内存使用率.html-BGxlA5wU.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-监控接口.html-Px3mIulD.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-监控磁盘使用率.html-Cy0eD0rc.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-监控网卡流量.html-DDiVI-nR.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本案例-目录判断.html-C68M3FXo.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell脚本用户交互.html-DrKLfOp8.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell运算实战案例-KFC点餐系统.html-DvE9_mMS.js" as="script"><link rel="prefetch" href="/vuepress/assets/shell运算详解.html-B8XnRdlN.js" as="script"><link rel="prefetch" href="/vuepress/assets/循环控制语句.html-sXUcszLw.js" as="script"><link rel="prefetch" href="/vuepress/assets/循环语句练习案例.html-DPa4M9cy.js" as="script"><link rel="prefetch" href="/vuepress/assets/正则表达式.html-DXtUAh8w.js" as="script"><link rel="prefetch" href="/vuepress/assets/流程控制-case语句.html-BWCUFhmR.js" as="script"><link rel="prefetch" href="/vuepress/assets/流程控制-for循环语句.html-xMpx6yDI.js" as="script"><link rel="prefetch" href="/vuepress/assets/流程控制-until语句.html-CiwGFsLe.js" as="script"><link rel="prefetch" href="/vuepress/assets/流程控制-while循环.html-DZYtCqTa.js" as="script"><link rel="prefetch" href="/vuepress/assets/编程语言与shell脚本.html-CjVF68nE.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、配置CA认证中心实现http取证.html-B6rNNcBN.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、认识电子邮件系统.html-C2OOWgMr.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、部署基础电子邮件系统.html-D4TOnnRD.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、认识动态主机配置协议.html-CX6aE_hD.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、搭建简单的dhcp服务器.html-BtjhHrFW.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、dhcp服务配置ip与mac地址绑定.html-BCPZ8Z2Z.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、使用VMware Workstation Pro安装部署 centos7系统.html-D1e-Nfko.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、使用Oracle VM VirtualBox安装部署centos7系统.html-bUWMqnBI.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、重置root密码.html-DpHDBGr1.js" as="script"><link rel="prefetch" href="/vuepress/assets/4、配置本地yum源.html-DSxJjVW1.js" as="script"><link rel="prefetch" href="/vuepress/assets/5、配置网络yum源.html-D9Ka1h33.js" as="script"><link rel="prefetch" href="/vuepress/assets/6、systemd初始化进程.html-Dd5FWmnK.js" as="script"><link rel="prefetch" href="/vuepress/assets/7、telnet管理主机.html-DdCbSPjb.js" as="script"><link rel="prefetch" href="/vuepress/assets/8、centos7中绑定双网卡配置.html-CvHMQAWj.js" as="script"><link rel="prefetch" href="/vuepress/assets/9、centos7中网卡添加多个ip地址.html-cMzXVUvs.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、常用系统工作命令.html-DZT93g2P.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、系统状态检测命令.html-fz84MuoY.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、工作目录切换命令.html-Cc4dY64I.js" as="script"><link rel="prefetch" href="/vuepress/assets/4、文本文件编辑命令.html-TgPhrL3p.js" as="script"><link rel="prefetch" href="/vuepress/assets/5、文件目录管理命令.html-CMRbvYr6.js" as="script"><link rel="prefetch" href="/vuepress/assets/6、打包压缩与搜索命令.html-nwQdoypl.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、认识数据库管理系统.html-B9E5okzn.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、安装初始化mariadb数据库系统.html-BxAsDLLm.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、修改数据库root用户密码.html-lyUuGul3.js" as="script"><link rel="prefetch" href="/vuepress/assets/4、管理账户以及授权.html-CsGUf9oB.js" as="script"><link rel="prefetch" href="/vuepress/assets/5、创建数据库与表单.html-8bnlzS6s.js" as="script"><link rel="prefetch" href="/vuepress/assets/6、管理表单及数据.html-znw-t361.js" as="script"><link rel="prefetch" href="/vuepress/assets/7、数据库的备份与恢复.html-B9eFAbbd.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、输入输出重定向.html-Dmz6KkbQ.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、管道符.html-BeCCSdwO.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、命令行的通配符.html-YPGeIlmi.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、vim文本编辑器.html-l33aE4DE.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、配置主机名.html-IeiQm3zb.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、配置网卡信息.html-B5BrhRdJ.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、用户身份与能力.html-B_ZjMtwl.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、文件权限与归属.html-D5gOx30L.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、su命令和sudo命令.html-BMnEGMR8.js" as="script"><link rel="prefetch" href="/vuepress/assets/10、根下扩容实.html-CIqCjl2d.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、磁盘文件存储结构.html-Cg-GANa2.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、物理设备的命名的规则.html-BSO_JSoa.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、文件系统.html-KxAS6O6z.js" as="script"><link rel="prefetch" href="/vuepress/assets/4、挂载硬件设备.html-BAPOpyrW.js" as="script"><link rel="prefetch" href="/vuepress/assets/5、添加交换分区.html-BmaEUE6P.js" as="script"><link rel="prefetch" href="/vuepress/assets/6、配置挂载文件开机自动挂载（永久挂载）.html-C48lbvKF.js" as="script"><link rel="prefetch" href="/vuepress/assets/7、磁盘配额.html-ZjYK2g77.js" as="script"><link rel="prefetch" href="/vuepress/assets/8、RAID独立冗余磁盘阵列技术.html-DkOU9wHP.js" as="script"><link rel="prefetch" href="/vuepress/assets/9、LVM （逻辑卷管理器）.html-BeL_qs3n.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、认识Apache与配置服务文件参数.html-zvCb9M33.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、利用Apache服务部署默认网站（单个）.html-Bw_7B4Mg.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、利用apache搭建多个ip对应多个站点.html-BreSCJiI.js" as="script"><link rel="prefetch" href="/vuepress/assets/4、利用apache配置基于ip_端口的虚拟主机.html-BaTi6-9t.js" as="script"><link rel="prefetch" href="/vuepress/assets/5、利用Apache搭建基于虚拟目录的虚拟主机.html-CR0kS1AS.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、网络文件系统NFS.html-BHSq4l_9.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、共享文件系统samba.html-D2gyZUPa.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、项目实战samba服务.html-MjJHLC9N.js" as="script"><link rel="prefetch" href="/vuepress/assets/4、使用vsftpd服务传输文件.html-D5-HZxIy.js" as="script"><link rel="prefetch" href="/vuepress/assets/5、利用vsftpd搭建实名ftp服务.html-wL3CAInu.js" as="script"><link rel="prefetch" href="/vuepress/assets/6、利用vsftpd搭建基于虚拟用户访问的ftp服务.html-BN09aau8.js" as="script"><link rel="prefetch" href="/vuepress/assets/1、了解DNS域名解析服务.html-DgkIzV0N.js" as="script"><link rel="prefetch" href="/vuepress/assets/2、利用bind服务程序搭建单区域dns服务.html-Ljks2JAE.js" as="script"><link rel="prefetch" href="/vuepress/assets/3、使用bind服务搭建多区域域名解析服务.html-C5M1X0vj.js" as="script"><link rel="prefetch" href="/vuepress/assets/4、使用bind部署dns主从服务器，实现dns冗余负载均衡.html-CAyAomau.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-BCvo8tnU.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-DLx3IKCl.js" as="script"><link rel="prefetch" href="/vuepress/assets/01.html-DR9tPgyz.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-B8UtTtIi.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-DwsBS9xV.js" as="script"><link rel="prefetch" href="/vuepress/assets/01.html-BRj-tlUt.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-C9JSpVFz.js" as="script"><link rel="prefetch" href="/vuepress/assets/01.html-DFL65ZIr.js" as="script"><link rel="prefetch" href="/vuepress/assets/02.html-ClWovrm5.js" as="script"><link rel="prefetch" href="/vuepress/assets/03.html-6l4r0uKl.js" as="script"><link rel="prefetch" href="/vuepress/assets/04.html-DyAxQra6.js" as="script"><link rel="prefetch" href="/vuepress/assets/05.html-B2FDgKhO.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-BX0b_jPf.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-BlW5Y-Fj.js" as="script"><link rel="prefetch" href="/vuepress/assets/404.html-Djp--OH2.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-DPGgJr3h.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-QNqEH8GC.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-CA1cNstr.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-CcwNgsKa.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-DTNSdSpQ.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-DMRsi_mV.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-pX8YEgpV.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-BJwrAhX8.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-DfOuXI4G.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-ZWRFiZRn.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-BDYAiNJJ.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-CcFl8R-I.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-De6EMxem.js" as="script"><link rel="prefetch" href="/vuepress/assets/waline-meta-l0sNRNKZ.js" as="script"><link rel="prefetch" href="/vuepress/assets/component-xVVJx_RC.js" as="script"><link rel="prefetch" href="/vuepress/assets/photoswipe.esm-GXRgw7eJ.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/vuepress/"><img class="vp-nav-logo" src="https://www.xxjsfb.cn/static/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">风华</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/vuepress/" aria-label="我的主页"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span><!--]-->我的主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/vuepress/portfolio.html" aria-label="我的帅照"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-image" style=""></span><!--]-->我的帅照<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/vuepress/note/" aria-label="我的笔记"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span><!--]-->我的笔记<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/vuepress/yl/" aria-label="友情连接"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-diagram-project" style=""></span><!--]-->友情连接<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><span class="font-icon icon fa-fw fa-sm fas fa-person-chalkboard" style=""></span><span class="vp-sidebar-title">我的笔记</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress/note/" aria-label="笔记"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><!--]-->笔记<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Centos笔记</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Docker笔记</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">kubernetes笔记</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress/note/kubernetes/" aria-label="kubernetes笔记"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><!--]-->kubernetes笔记<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">1、安装篇</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress/note/kubernetes/install/" aria-label="1、安装篇"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><!--]-->1、安装篇<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">二进制安装</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">kubeadm安装</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress/note/kubernetes/install/kubeadm/" aria-label="kubeadm安装"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><!--]-->kubeadm安装<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">1、安装1主2从</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">2、安装3主3从</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress/note/kubernetes/install/kubeadm/High%20availability/" aria-label="2、安装3主3从"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><!--]-->2、安装3主3从<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/vuepress/note/kubernetes/install/kubeadm/High%20availability/01.html" aria-label="01-部署3主3从的高可用集群"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span><!--]-->01-部署3主3从的高可用集群<!----></a></li></ul></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">kubesphere安装</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">rke2安装</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Prometheus笔记</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Shell笔记</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Supervisor笔记</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>01-部署3主3从的高可用集群</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="/portfolio" target="_blank" rel="noopener noreferrer">风华</a></span><span property="author" content="风华"></span></span><!----><!----><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon" name="eye"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="vp-pageview waline-pageview-count" data-path="/note/kubernetes/install/kubeadm/High%20availability/01.html" data-page-key="/note/kubernetes/install/kubeadm/High%20availability/01.html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 19 分钟</span><meta property="timeRequired" content="PT19M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1、主机操作系统说明">1、主机操作系统说明</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_2、主机硬件配置说明">2、主机硬件配置说明</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3、主机配置">3、主机配置</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-1、配置yum源-所有主机都配置">3.1、配置yum源，所有主机都配置</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-2、修改主机名-配置hosts本地解析">3.2、修改主机名，配置hosts本地解析</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-3、所有节点优化">3.3、所有节点优化</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-4、配置免密-中控机操作-master01">3.4、配置免密[中控机操作:master01]</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-5、升级内核">3.5、升级内核</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-6、所有节点安装ipvsadm">3.6、所有节点安装ipvsadm</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-7、k8s内核优化">3.7、k8s内核优化</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-8、基本组件安装">3.8、基本组件安装</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4、kubernetes集群初始化">4、kubernetes集群初始化</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-2、master02-master03-加入master集群">4.2、master02 master03 加入master集群</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-3、worker01-worker02-worker03-加入master集群">4.3、worker01 worker02 worker03 加入master集群</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-4、加入结果预览">4.4、加入结果预览</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-5、master01节点配置环境变量-用于访问kubernetes集群">4.5、Master01节点配置环境变量，用于访问Kubernetes集群：</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_5、安装calico网络组件-master01操作">5、安装calico网络组件[master01操作]</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_6、安装dashboard">6、安装dashboard</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_7、通过https协议进行访问">7、通过https协议进行访问</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_8、-配置修改">8、 配置修改</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_9、-高可用测试">9、 高可用测试</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_10、-安装kuboard集群管理面板">10、 安装Kuboard集群管理面板</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><p><a style="color:blue;font-size:30px;">部署3主3从的kubernetes1.21.0高可用集群环境</a></p><p>参考地址：https://www.cnblogs.com/superlinux/p/14676959.html</p><h2 id="_1、主机操作系统说明" tabindex="-1"><a class="header-anchor" href="#_1、主机操作系统说明"><span>1、主机操作系统说明</span></a></h2><table><thead><tr><th>序号</th><th>操作系统及版本</th><th>备注</th></tr></thead><tbody><tr><td>1</td><td>centos7.6</td><td></td></tr></tbody></table><h2 id="_2、主机硬件配置说明" tabindex="-1"><a class="header-anchor" href="#_2、主机硬件配置说明"><span>2、主机硬件配置说明</span></a></h2><table><thead><tr><th>需求</th><th>CPU</th><th>内存</th><th>硬盘</th><th>角色</th><th>主机名</th><th>ip地址</th><th>备注</th></tr></thead><tbody><tr><td>值</td><td>4C</td><td>8G</td><td>100G</td><td>master</td><td>k8s-master01</td><td>192.168.10.21</td><td></td></tr><tr><td>值</td><td>4C</td><td>8G</td><td>100G</td><td>master</td><td>k8s-master02</td><td>192.168.10.22</td><td></td></tr><tr><td>值</td><td>4C</td><td>8G</td><td>100G</td><td>master</td><td>k8s-master03</td><td>192.168.10.23</td><td></td></tr><tr><td>值</td><td>4C</td><td>8G</td><td>100G</td><td>worker（node）</td><td>k8s-worker01</td><td>192.168.10.24</td><td></td></tr><tr><td>值</td><td>4C</td><td>8G</td><td>100G</td><td>worker（node）</td><td>k8s-worker02</td><td>192.168.10.25</td><td></td></tr><tr><td>值</td><td>4C</td><td>8G</td><td>100G</td><td>worker（node）</td><td>k8s-worker03</td><td>192.168.10.26</td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td>k8s-master-lb</td><td>192.168.10.100</td><td></td></tr></tbody></table><table><thead><tr><th>序号</th><th>主机名</th><th>功能</th><th>备注</th></tr></thead><tbody><tr><td>1</td><td>master01</td><td>haproxy、keepalived</td><td>keepalived主节点</td></tr><tr><td>2</td><td>master02</td><td>haproxy、keepalived</td><td>keepalived从节点</td></tr><tr><td>3</td><td>master03</td><td>haproxy、keepalived</td><td>keepalived从节点</td></tr></tbody></table><p><strong>花里胡哨的美化配置</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#命令行优化：</span></span>
<span class="line"><span>echo &quot;export PS1=&#39;\[\033[01;31m\]\u\[\033[00m\]@\[\033[01;32m\]\h\[\033[00m\][\[\033[01;33m\]\t\[\033[00m\]]:\[\033[01;34m\]\w\[\033[00m\]$ &#39;&quot; &gt;&gt;/etc/profile</span></span>
<span class="line"><span>source /etc/profile</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#历史记录优化： </span></span>
<span class="line"><span>export HISTTIMEFORMAT=&#39;%F %T &#39; </span></span>
<span class="line"><span>echo &quot;export HISTTIMEFORMAT=&#39;%F %T &#39;&quot; &gt;&gt;/etc/profile </span></span>
<span class="line"><span>source /etc/profile</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3、主机配置" tabindex="-1"><a class="header-anchor" href="#_3、主机配置"><span>3、主机配置</span></a></h2><h3 id="_3-1、配置yum源-所有主机都配置" tabindex="-1"><a class="header-anchor" href="#_3-1、配置yum源-所有主机都配置"><span>3.1、配置yum源，所有主机都配置</span></a></h3><blockquote><p>采用阿里云源</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>rm -rf  /etc/yum.repos.d/*</span></span>
<span class="line"><span>cd /etc/yum.repos.d/</span></span>
<span class="line"><span>curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span></span>
<span class="line"><span>yum install -y yum-utils device-mapper-persistent-data lvm2</span></span>
<span class="line"><span>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span>
<span class="line"><span>[kubernetes]</span></span>
<span class="line"><span>name=Kubernetes</span></span>
<span class="line"><span>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span>
<span class="line"><span>enabled=1</span></span>
<span class="line"><span>gpgcheck=1</span></span>
<span class="line"><span>repo_gpgcheck=1</span></span>
<span class="line"><span>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span>sed -i -e &#39;/mirrors.cloud.aliyuncs.com/d&#39; -e &#39;/mirrors.aliyuncs.com/d&#39; /etc/yum.repos.d/CentOS-Base.repo</span></span>
<span class="line"><span>yum clean all</span></span>
<span class="line"><span>yum install -y epel-release</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#安装必备工具：</span></span>
<span class="line"><span>#必备工具安装</span></span>
<span class="line"><span>yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>下载安装所有的源码文件，后面需要用到</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cd /root/ </span></span>
<span class="line"><span>git clone https://github.com/dotbalo/k8s-ha-install.git</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#如果无法下载请使用下面的重试：</span></span>
<span class="line"><span>git clone https://gitee.com/dukuan/k8s-ha-install.git</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2、修改主机名-配置hosts本地解析" tabindex="-1"><a class="header-anchor" href="#_3-2、修改主机名-配置hosts本地解析"><span>3.2、修改主机名，配置hosts本地解析</span></a></h3><blockquote><p>master01为例，其他主机均配置，注意主机名</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>hostnamectl set-hostname k8s-master01</span></span>
<span class="line"><span>bash</span></span>
<span class="line"><span>cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span></span>
<span class="line"><span>192.168.3.31 k8s-master01</span></span>
<span class="line"><span>192.168.3.32 k8s-master02</span></span>
<span class="line"><span>192.168.3.33 k8s-master03</span></span>
<span class="line"><span>192.168.3.34 k8s-worker01</span></span>
<span class="line"><span>192.168.3.35 k8s-worker02</span></span>
<span class="line"><span>192.168.3.36 k8s-worker03</span></span>
<span class="line"><span>192.168.3.100 k8s-master-lb</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span>cat /etc/hosts</span></span>
<span class="line"><span>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span></span>
<span class="line"><span>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span></span>
<span class="line"><span>192.168.3.31 k8s-master01</span></span>
<span class="line"><span>192.168.3.32 k8s-master02</span></span>
<span class="line"><span>192.168.3.33 k8s-master03</span></span>
<span class="line"><span>192.168.3.34 k8s-worker01</span></span>
<span class="line"><span>192.168.3.35 k8s-worker02</span></span>
<span class="line"><span>192.168.3.36 k8s-worker03</span></span>
<span class="line"><span>192.168.3.100 k8s-master-lb</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>完成以后在master01上测试连通性</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>[root@master01 ~]# ping k8s-worker01</span></span>
<span class="line"><span>[root@master01 ~]# ping k8s-worker02</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#以下以master01结果为例</span></span>
<span class="line"><span>[root@master01 ~]# ping worker01 </span></span>
<span class="line"><span>PING worker01 (192.168.10.22) 56(84) bytes of data.</span></span>
<span class="line"><span>64 bytes from worker01 (192.168.10.22): icmp_seq=1 ttl=64 time=0.652 ms</span></span>
<span class="line"><span>64 bytes from worker01 (192.168.10.22): icmp_seq=2 ttl=64 time=0.430 ms</span></span>
<span class="line"><span>^C</span></span>
<span class="line"><span>--- worker01 ping statistics ---</span></span>
<span class="line"><span>2 packets transmitted, 2 received, 0% packet loss, time 1065ms</span></span>
<span class="line"><span>rtt min/avg/max/mdev = 0.430/0.541/0.652/0.111 ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[root@master01 ~]# ping worker02</span></span>
<span class="line"><span>PING worker02 (192.168.10.23) 56(84) bytes of data.</span></span>
<span class="line"><span>64 bytes from worker02 (192.168.10.23): icmp_seq=1 ttl=64 time=0.774 ms</span></span>
<span class="line"><span>64 bytes from worker02 (192.168.10.23): icmp_seq=2 ttl=64 time=0.444 ms</span></span>
<span class="line"><span>^C</span></span>
<span class="line"><span>--- worker02 ping statistics ---</span></span>
<span class="line"><span>2 packets transmitted, 2 received, 0% packet loss, time 1019ms</span></span>
<span class="line"><span>rtt min/avg/max/mdev = 0.444/0.609/0.774/0.165 ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>------</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3、所有节点优化" tabindex="-1"><a class="header-anchor" href="#_3-3、所有节点优化"><span>3.3、所有节点优化</span></a></h3><blockquote><p>master01为例，其他主机均配置，配置完成后 <em><strong>重启主机</strong></em></p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#所有节点关闭防火墙、selinux、dnsmasq、swap。服务器配置如下：</span></span>
<span class="line"><span>systemctl disable --now firewalld </span></span>
<span class="line"><span>systemctl disable --now dnsmasq</span></span>
<span class="line"><span></span></span>
<span class="line"><span>setenforce 0</span></span>
<span class="line"><span>sed -i &#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39; /etc/sysconfig/selinux</span></span>
<span class="line"><span>sed -i &#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39; /etc/selinux/config</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#关闭swap分区</span></span>
<span class="line"><span>swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span></span>
<span class="line"><span>sed -ri &#39;/^[^#]*swap/s@^@#@&#39; /etc/fstab</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#安装ntpdate</span></span>
<span class="line"><span>rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#添加计划任务</span></span>
<span class="line"><span>yum install -y ntpdate</span></span>
<span class="line"><span>echo &#39;*/5 * * * * ntpdate cn.pool.ntp.org&#39; &gt;&gt;/var/spool/cron/root</span></span>
<span class="line"><span>systemctl restart crond</span></span>
<span class="line"><span>ntpdate time2.aliyun.com</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#所有节点同步时间。时间同步配置如下：</span></span>
<span class="line"><span>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span>
<span class="line"><span>echo &#39;Asia/Shanghai&#39; &gt;/etc/timezone</span></span>
<span class="line"><span>ntpdate time2.aliyun.com</span></span>
<span class="line"><span># 加入到crontab</span></span>
<span class="line"><span>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#limit优化</span></span>
<span class="line"><span>ulimit -SHn 65535</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cat &lt;&lt;EOF &gt;&gt; /etc/security/limits.conf</span></span>
<span class="line"><span>* soft nofile 655360</span></span>
<span class="line"><span>* hard nofile 131072</span></span>
<span class="line"><span>* soft nproc 655350</span></span>
<span class="line"><span>* hard nproc 655350</span></span>
<span class="line"><span>* soft memlock unlimited</span></span>
<span class="line"><span>* hard memlock unlimited</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4、配置免密-中控机操作-master01" tabindex="-1"><a class="header-anchor" href="#_3-4、配置免密-中控机操作-master01"><span>3.4、配置免密[中控机操作:master01]</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#Master01节点免密钥登录其他节点，安装过程中生成配置文件和证书均在Master01上操作，集群管理也在Master01上操作，阿里云或者AWS上需要单独一台kubectl服务器。密钥配置如下：</span></span>
<span class="line"><span>cd /root</span></span>
<span class="line"><span>ssh-keygen -t rsa</span></span>
<span class="line"><span>for i in k8s-master01 k8s-master02 k8s-master03 k8s-worker01 k8s-worker02 k8s-worker03;do ssh-copy-id -i .ssh/id_rsa.pub $i;done</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5、升级内核" tabindex="-1"><a class="header-anchor" href="#_3-5、升级内核"><span>3.5、升级内核</span></a></h3><blockquote><p>原文：https://www.xxjsfb.cn/doc/275/</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#启用 ELRepo 只需要执行命令：</span></span>
<span class="line"><span>yum -y install elrepo-release</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># 列出可用的内核相关包：</span></span>
<span class="line"><span>yum --disablerepo=&quot;*&quot; --enablerepo=&quot;elrepo-kernel&quot; list available</span></span>
<span class="line"><span>yum --disablerepo=&quot;*&quot; --enablerepo=&quot;elrepo-kernel&quot; list available --showduplicates #查看所有版本</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 根据上述查询结果，安装内核相关包</span></span>
<span class="line"><span># 安装新内核</span></span>
<span class="line"><span>yum --disablerepo=\* --enablerepo=elrepo-kernel install -y kernel-ml.x86_64</span></span>
<span class="line"><span>#kernel-core、kernel-modules 与 kernel 依赖自动更新</span></span>
<span class="line"><span># 安装新内核相关软件</span></span>
<span class="line"><span>yum --disablerepo=\* --enablerepo=elrepo-kernel install -y kernel-ml-devel kernel-ml-tools kernel-ml-tools-libs kernel-ml-tools-libs-devel kernel-ml-headers --skip-broken</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#查看系统安装的全部内核：</span></span>
<span class="line"><span>root@k8s-master01[18:08:45]:~$ grubby --info=ALL</span></span>
<span class="line"><span>index=0</span></span>
<span class="line"><span>kernel=/boot/vmlinuz-6.6.11-1.el7.elrepo.x86_64</span></span>
<span class="line"><span>args=&quot;ro crashkernel=auto rd.lvm.lv=centos/root rhgb quiet LANG=en_US.UTF-8&quot;</span></span>
<span class="line"><span>root=/dev/mapper/centos-root</span></span>
<span class="line"><span>initrd=/boot/initramfs-6.6.11-1.el7.elrepo.x86_64.img</span></span>
<span class="line"><span>title=CentOS Linux (6.6.11-1.el7.elrepo.x86_64) 7 (Core)</span></span>
<span class="line"><span>index=1</span></span>
<span class="line"><span>kernel=/boot/vmlinuz-3.10.0-957.el7.x86_64</span></span>
<span class="line"><span>args=&quot;ro crashkernel=auto rd.lvm.lv=centos/root rhgb quiet LANG=en_US.UTF-8&quot;</span></span>
<span class="line"><span>root=/dev/mapper/centos-root</span></span>
<span class="line"><span>initrd=/boot/initramfs-3.10.0-957.el7.x86_64.img</span></span>
<span class="line"><span>title=CentOS Linux (3.10.0-957.el7.x86_64) 7 (Core)</span></span>
<span class="line"><span>index=2</span></span>
<span class="line"><span>kernel=/boot/vmlinuz-0-rescue-6b99fdbc99164b2d8a41e9891d315802</span></span>
<span class="line"><span>args=&quot;ro crashkernel=auto rd.lvm.lv=centos/root rhgb quiet&quot;</span></span>
<span class="line"><span>root=/dev/mapper/centos-root</span></span>
<span class="line"><span>initrd=/boot/initramfs-0-rescue-6b99fdbc99164b2d8a41e9891d315802.img</span></span>
<span class="line"><span>title=CentOS Linux (0-rescue-6b99fdbc99164b2d8a41e9891d315802) 7 (Core)</span></span>
<span class="line"><span>index=3</span></span>
<span class="line"><span>non linux entry</span></span>
<span class="line"><span>You have new mail in /var/spool/mail/root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#使用路径来指定内核，可以使用 --set-default=kernel-path</span></span>
<span class="line"><span>root@k8s-master01[18:18:16]:~$grubby --set-default=/boot/vmlinuz-6.6.11-1.el7.elrepo.x86_64</span></span>
<span class="line"><span></span></span>
<span class="line"><span>root@k8s-master01[18:18:16]:~$ grubby --default-kernel</span></span>
<span class="line"><span>/boot/vmlinuz-6.6.11-1.el7.elrepo.x86_64</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#重启</span></span>
<span class="line"><span>reboot</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6、所有节点安装ipvsadm" tabindex="-1"><a class="header-anchor" href="#_3-6、所有节点安装ipvsadm"><span>3.6、所有节点安装ipvsadm</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>yum install ipvsadm ipset sysstat conntrack libseccomp -y </span></span>
<span class="line"><span> </span></span>
<span class="line"><span> </span></span>
<span class="line"><span>#所有节点配置ipvs模块，在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack， 4.18以下使用nf_conntrack_ipv4即可： </span></span>
<span class="line"><span> </span></span>
<span class="line"><span>modprobe -- ip_vs </span></span>
<span class="line"><span>modprobe -- ip_vs_rr </span></span>
<span class="line"><span>modprobe -- ip_vs_wrr </span></span>
<span class="line"><span>modprobe -- ip_vs_sh </span></span>
<span class="line"><span>modprobe -- nf_conntrack </span></span>
<span class="line"><span></span></span>
<span class="line"><span> </span></span>
<span class="line"><span>#创建 /etc/modules-load.d/ipvs.conf 并加入以下内容： </span></span>
<span class="line"><span>cat &gt;/etc/modules-load.d/ipvs.conf &lt;&lt;EOF </span></span>
<span class="line"><span>ip_vs </span></span>
<span class="line"><span>ip_vs_lc </span></span>
<span class="line"><span>ip_vs_wlc </span></span>
<span class="line"><span>ip_vs_rr </span></span>
<span class="line"><span>ip_vs_wrr </span></span>
<span class="line"><span>ip_vs_lblc </span></span>
<span class="line"><span>ip_vs_lblcr </span></span>
<span class="line"><span>ip_vs_dh </span></span>
<span class="line"><span>ip_vs_sh </span></span>
<span class="line"><span>ip_vs_fo </span></span>
<span class="line"><span>ip_vs_nq </span></span>
<span class="line"><span>ip_vs_sed </span></span>
<span class="line"><span>ip_vs_ftp </span></span>
<span class="line"><span>ip_vs_sh </span></span>
<span class="line"><span>nf_conntrack </span></span>
<span class="line"><span>ip_tables </span></span>
<span class="line"><span>ip_set </span></span>
<span class="line"><span>xt_set </span></span>
<span class="line"><span>ipt_set </span></span>
<span class="line"><span>ipt_rpfilter </span></span>
<span class="line"><span>ipt_REJECT </span></span>
<span class="line"><span>ipip </span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#设置为开机启动</span></span>
<span class="line"><span>systemctl enable --now systemd-modules-load.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-7、k8s内核优化" tabindex="-1"><a class="header-anchor" href="#_3-7、k8s内核优化"><span>3.7、k8s内核优化</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#开启一些k8s集群中必须的内核参数，所有节点配置k8s内核：</span></span>
<span class="line"><span>cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span></span>
<span class="line"><span>net.ipv4.ip_forward = 1</span></span>
<span class="line"><span>net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"><span>net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span>fs.may_detach_mounts = 1</span></span>
<span class="line"><span>vm.overcommit_memory=1</span></span>
<span class="line"><span>vm.panic_on_oom=0</span></span>
<span class="line"><span>fs.inotify.max_user_watches=89100</span></span>
<span class="line"><span>fs.file-max=52706963</span></span>
<span class="line"><span>fs.nr_open=52706963</span></span>
<span class="line"><span>net.netfilter.nf_conntrack_max=2310720</span></span>
<span class="line"><span></span></span>
<span class="line"><span>net.ipv4.tcp_keepalive_time = 600</span></span>
<span class="line"><span>net.ipv4.tcp_keepalive_probes = 3</span></span>
<span class="line"><span>net.ipv4.tcp_keepalive_intvl =15</span></span>
<span class="line"><span>net.ipv4.tcp_max_tw_buckets = 36000</span></span>
<span class="line"><span>net.ipv4.tcp_tw_reuse = 1</span></span>
<span class="line"><span>net.ipv4.tcp_max_orphans = 327680</span></span>
<span class="line"><span>net.ipv4.tcp_orphan_retries = 3</span></span>
<span class="line"><span>net.ipv4.tcp_syncookies = 1</span></span>
<span class="line"><span>net.ipv4.tcp_max_syn_backlog = 16384</span></span>
<span class="line"><span>net.ipv4.ip_conntrack_max = 65536</span></span>
<span class="line"><span>net.ipv4.tcp_max_syn_backlog = 16384</span></span>
<span class="line"><span>net.ipv4.tcp_timestamps = 0</span></span>
<span class="line"><span>net.core.somaxconn = 16384</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span>sysctl --system</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#所有节点配置完内核后，重启服务器，保证重启后内核依旧加载</span></span>
<span class="line"><span></span></span>
<span class="line"><span>reboot</span></span>
<span class="line"><span>lsmod | grep --color=auto -e ip_vs -e nf_conntrack</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#重启后结果如下代表正常：</span></span>
<span class="line"><span>root@k8s-master01[17:19:15]:~$ lsmod | grep --color=auto -e ip_vs -e nf_conntrack </span></span>
<span class="line"><span>ip_vs_ftp              16384  0  </span></span>
<span class="line"><span>nf_nat                 32768  1 ip_vs_ftp </span></span>
<span class="line"><span>ip_vs_sed              16384  0  </span></span>
<span class="line"><span>ip_vs_nq               16384  0  </span></span>
<span class="line"><span>ip_vs_fo               16384  0  </span></span>
<span class="line"><span>ip_vs_sh               16384  0  </span></span>
<span class="line"><span>ip_vs_dh               16384  0  </span></span>
<span class="line"><span>ip_vs_lblcr            16384  0  </span></span>
<span class="line"><span>ip_vs_lblc             16384  0  </span></span>
<span class="line"><span>ip_vs_wrr              16384  0  </span></span>
<span class="line"><span>ip_vs_rr               16384  0  </span></span>
<span class="line"><span>ip_vs_wlc              16384  0  </span></span>
<span class="line"><span>ip_vs_lc               16384  0  </span></span>
<span class="line"><span>ip_vs                 151552  24 ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp </span></span>
<span class="line"><span>nf_conntrack          143360  2 nf_nat,ip_vs </span></span>
<span class="line"><span>nf_defrag_ipv6         20480  1 nf_conntrack </span></span>
<span class="line"><span>nf_defrag_ipv4         16384  1 nf_conntrack </span></span>
<span class="line"><span>libcrc32c              16384  4 nf_conntrack,nf_nat,xfs,ip_vs</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-8、基本组件安装" tabindex="-1"><a class="header-anchor" href="#_3-8、基本组件安装"><span>3.8、基本组件安装</span></a></h3><h4 id="_3-8-1、所有节点安装-docker-ce-20-10" tabindex="-1"><a class="header-anchor" href="#_3-8-1、所有节点安装-docker-ce-20-10"><span>3.8.1、所有节点安装 docker-ce 20.10</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>yum install -y docker-ce-20.10.6-* docker-ce-cli-20.10.6-*.x86_64</span></span>
<span class="line"><span>rm -f /etc/docker/* </span></span>
<span class="line"><span>sudo mkdir -p /etc/docker </span></span>
<span class="line"><span>sudo tee /etc/docker/daemon.json &lt;&lt;-&#39;EOF&#39; </span></span>
<span class="line"><span>{ </span></span>
<span class="line"><span>  &quot;registry-mirrors&quot;: [&quot;https://ajvcw8qn.mirror.aliyuncs.com&quot;],</span></span>
<span class="line"><span>  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;] </span></span>
<span class="line"><span>} </span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span>sudo systemctl daemon-reload </span></span>
<span class="line"><span>sudo systemctl restart docker </span></span>
<span class="line"><span>systemctl enable --now  docker.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-8-2、所有机器安装k8s组件kubeadm" tabindex="-1"><a class="header-anchor" href="#_3-8-2、所有机器安装k8s组件kubeadm"><span>3.8.2、所有机器安装k8s组件kubeadm</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>yum list kubeadm.x86_64 --showduplicates | sort -r</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#所有节点安装最新版本kubeadm： </span></span>
<span class="line"><span>yum install kubeadm-1.21* kubelet-1.21* kubectl-1.21* -y</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#默认配置的pause镜像使用gcr.io仓库，国内可能无法访问，所以这里配置Kubelet使用阿里云的pause镜像</span></span>
<span class="line"><span>cat &gt;/etc/sysconfig/kubelet&lt;&lt;EOF</span></span>
<span class="line"><span>KUBELET_EXTRA_ARGS=&quot;--cgroup-driver=systemd --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2&quot;</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#设置开机启动</span></span>
<span class="line"><span>systemctl daemon-reload</span></span>
<span class="line"><span>systemctl enable --now kubelet</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-8-3、安装高可用组件-master相关服务器执行" tabindex="-1"><a class="header-anchor" href="#_3-8-3、安装高可用组件-master相关服务器执行"><span>3.8.3、安装高可用组件[master相关服务器执行]</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#所有Master节点通过yum安装HAProxy和KeepAlived：</span></span>
<span class="line"><span>root@k8s-master01[17:44:47]:~$  yum install keepalived haproxy -y</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#配置HAProxy：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#所有Master节点配置HAProxy（详细配置参考HAProxy文档，所有Master节点的HAProxy配置相同）：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mkdir /etc/haproxy</span></span>
<span class="line"><span>cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>global</span></span>
<span class="line"><span> maxconn 2000</span></span>
<span class="line"><span> ulimit-n 16384</span></span>
<span class="line"><span> log 127.0.0.1 local0 err</span></span>
<span class="line"><span> stats timeout 30s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>defaults</span></span>
<span class="line"><span> log global</span></span>
<span class="line"><span> mode http</span></span>
<span class="line"><span> option httplog</span></span>
<span class="line"><span> timeout connect 5000</span></span>
<span class="line"><span> timeout client 50000</span></span>
<span class="line"><span> timeout server 50000</span></span>
<span class="line"><span> timeout http-request 15s</span></span>
<span class="line"><span> timeout http-keep-alive 15s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>frontend monitor-in</span></span>
<span class="line"><span> bind *:33305</span></span>
<span class="line"><span> mode http</span></span>
<span class="line"><span> option httplog</span></span>
<span class="line"><span> monitor-uri /monitor</span></span>
<span class="line"><span></span></span>
<span class="line"><span>frontend k8s-master</span></span>
<span class="line"><span> bind 0.0.0.0:16443</span></span>
<span class="line"><span> bind 127.0.0.1:16443</span></span>
<span class="line"><span> mode tcp</span></span>
<span class="line"><span> option tcplog</span></span>
<span class="line"><span> tcp-request inspect-delay 5s</span></span>
<span class="line"><span> default_backend k8s-master</span></span>
<span class="line"><span></span></span>
<span class="line"><span>backend k8s-master</span></span>
<span class="line"><span> mode tcp</span></span>
<span class="line"><span> option tcplog</span></span>
<span class="line"><span> option tcp-check</span></span>
<span class="line"><span> balance roundrobin</span></span>
<span class="line"><span> default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span></span>
<span class="line"><span> server k8s-master01  192.168.3.31:6443 check</span></span>
<span class="line"><span> server k8s-master02  192.168.3.32:6443 check</span></span>
<span class="line"><span> server k8s-master03  192.168.3.33:6443 check</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#所有Master节点配置KeepAlived，配置不一样，注意区分</span></span>
<span class="line"><span>#[root@k8s-master01 pki]# vim /etc/keepalived/keepalived.conf ，注意每个节点的IP和网卡（interface参数）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#注意修改配置，下面IP替换为master的IP地址：</span></span>
<span class="line"><span>server k8s-master01  192.168.3.31:6443 check</span></span>
<span class="line"><span>server k8s-master02  192.168.3.32:6443 check</span></span>
<span class="line"><span>server k8s-master03  192.168.3.33:6443 check</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#配置keepalived</span></span>
<span class="line"><span>#所有Master节点配置KeepAlived，配置不一样，注意区分 </span></span>
<span class="line"><span>#每台服务器 优先级必须不同 priority 100 其他机器设置为 99 98 </span></span>
<span class="line"><span>#master01 配置：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[root@k8s-master01 pki]# mkdir -p /etc/keepalived</span></span>
<span class="line"><span>[root@k8s-master01 pki]# cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>! Configuration File for keepalived</span></span>
<span class="line"><span>global_defs {</span></span>
<span class="line"><span>   router_id LVS_DEVEL</span></span>
<span class="line"><span>script_user root</span></span>
<span class="line"><span>   enable_script_security</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>vrrp_script chk_apiserver {</span></span>
<span class="line"><span>   script &quot;/etc/keepalived/check_apiserver.sh&quot;</span></span>
<span class="line"><span>   interval 5</span></span>
<span class="line"><span>   weight -5</span></span>
<span class="line"><span>   fall 2 </span></span>
<span class="line"><span>rise 1</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>vrrp_instance VI_1 {</span></span>
<span class="line"><span>   state MASTER</span></span>
<span class="line"><span>   interface eth0</span></span>
<span class="line"><span>   mcast_src_ip 192.168.3.31</span></span>
<span class="line"><span>   virtual_router_id 51</span></span>
<span class="line"><span>   priority 100</span></span>
<span class="line"><span>   advert_int 2</span></span>
<span class="line"><span>   authentication {</span></span>
<span class="line"><span>       auth_type PASS</span></span>
<span class="line"><span>       auth_pass K8SHA_KA_AUTH</span></span>
<span class="line"><span>   }</span></span>
<span class="line"><span>   virtual_ipaddress {</span></span>
<span class="line"><span>       192.168.3.100</span></span>
<span class="line"><span>   }</span></span>
<span class="line"><span>   track_script {</span></span>
<span class="line"><span>      chk_apiserver</span></span>
<span class="line"><span>   }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#Master02 配置：</span></span>
<span class="line"><span>[root@k8s-master02 pki]# cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>! Configuration File for keepalived</span></span>
<span class="line"><span>global_defs {</span></span>
<span class="line"><span>   router_id LVS_DEVEL</span></span>
<span class="line"><span>script_user root</span></span>
<span class="line"><span>   enable_script_security</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>vrrp_script chk_apiserver {</span></span>
<span class="line"><span>   script &quot;/etc/keepalived/check_apiserver.sh&quot;</span></span>
<span class="line"><span>  interval 5</span></span>
<span class="line"><span>   weight -5</span></span>
<span class="line"><span>   fall 2 </span></span>
<span class="line"><span>rise 1</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>vrrp_instance VI_1 {</span></span>
<span class="line"><span>   state BACKUP</span></span>
<span class="line"><span>   interface eth0</span></span>
<span class="line"><span>   mcast_src_ip 192.168.3.32</span></span>
<span class="line"><span>   virtual_router_id 51</span></span>
<span class="line"><span>   priority 99</span></span>
<span class="line"><span>   advert_int 2</span></span>
<span class="line"><span>   authentication {</span></span>
<span class="line"><span>       auth_type PASS</span></span>
<span class="line"><span>       auth_pass K8SHA_KA_AUTH</span></span>
<span class="line"><span>   }</span></span>
<span class="line"><span>   virtual_ipaddress {</span></span>
<span class="line"><span>       192.168.3.100</span></span>
<span class="line"><span>   }</span></span>
<span class="line"><span>   track_script {</span></span>
<span class="line"><span>      chk_apiserver</span></span>
<span class="line"><span>   }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#Master03 配置：</span></span>
<span class="line"><span>[root@k8s-master03 pki]# cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>! Configuration File for keepalived</span></span>
<span class="line"><span>global_defs {</span></span>
<span class="line"><span>   router_id LVS_DEVEL</span></span>
<span class="line"><span>script_user root</span></span>
<span class="line"><span>   enable_script_security</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>vrrp_script chk_apiserver {</span></span>
<span class="line"><span>   script &quot;/etc/keepalived/check_apiserver.sh&quot;</span></span>
<span class="line"><span> interval 5</span></span>
<span class="line"><span>   weight -5</span></span>
<span class="line"><span>   fall 2 </span></span>
<span class="line"><span>rise 1</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>vrrp_instance VI_1 {</span></span>
<span class="line"><span>   state BACKUP</span></span>
<span class="line"><span>   interface eth0</span></span>
<span class="line"><span>   mcast_src_ip 192.168.3.33</span></span>
<span class="line"><span>   virtual_router_id 51</span></span>
<span class="line"><span>   priority 98</span></span>
<span class="line"><span>   advert_int 2</span></span>
<span class="line"><span>   authentication {</span></span>
<span class="line"><span>       auth_type PASS</span></span>
<span class="line"><span>       auth_pass K8SHA_KA_AUTH</span></span>
<span class="line"><span>   }</span></span>
<span class="line"><span>   virtual_ipaddress {</span></span>
<span class="line"><span>       192.168.3.100</span></span>
<span class="line"><span>   }</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#快捷办法[变量获取本机IP]：</span></span>
<span class="line"><span>host=$(hostname -i)</span></span>
<span class="line"><span>cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;EOF </span></span>
<span class="line"><span>! Configuration File for keepalived </span></span>
<span class="line"><span>global_defs { </span></span>
<span class="line"><span>   router_id LVS_DEVEL </span></span>
<span class="line"><span>script_user root </span></span>
<span class="line"><span>   enable_script_security </span></span>
<span class="line"><span>} </span></span>
<span class="line"><span>vrrp_script chk_apiserver { </span></span>
<span class="line"><span>   script &quot;/etc/keepalived/check_apiserver.sh&quot; </span></span>
<span class="line"><span>   interval 5 </span></span>
<span class="line"><span>   weight -5 </span></span>
<span class="line"><span>   fall 2  </span></span>
<span class="line"><span>rise 1 </span></span>
<span class="line"><span>} </span></span>
<span class="line"><span>vrrp_instance VI_1 { </span></span>
<span class="line"><span>   state MASTER </span></span>
<span class="line"><span>   interface eth0 </span></span>
<span class="line"><span>   mcast_src_ip $(hostname -i) </span></span>
<span class="line"><span>   virtual_router_id 51 </span></span>
<span class="line"><span>   priority 101 </span></span>
<span class="line"><span>   advert_int 2 </span></span>
<span class="line"><span>   authentication { </span></span>
<span class="line"><span>       auth_type PASS </span></span>
<span class="line"><span>       auth_pass K8SHA_KA_AUTH </span></span>
<span class="line"><span>   } </span></span>
<span class="line"><span>   virtual_ipaddress { </span></span>
<span class="line"><span>       192.168.3.100 </span></span>
<span class="line"><span>   } </span></span>
<span class="line"><span>   track_script { </span></span>
<span class="line"><span>      chk_apiserver </span></span>
<span class="line"><span>   } </span></span>
<span class="line"><span>} </span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-8-4、健康检查配置-所有master服务器添加健康检查脚本" tabindex="-1"><a class="header-anchor" href="#_3-8-4、健康检查配置-所有master服务器添加健康检查脚本"><span>3.8.4、健康检查配置[所有master服务器添加健康检查脚本]</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &gt; /etc/keepalived/check_apiserver.sh &lt;&lt;&quot;EOF&quot;</span></span>
<span class="line"><span>#!/bin/bash</span></span>
<span class="line"><span>err=0</span></span>
<span class="line"><span>for k in $(seq 1 3)</span></span>
<span class="line"><span>do</span></span>
<span class="line"><span>   check_code=$(pgrep haproxy)</span></span>
<span class="line"><span>   if [[ $check_code == &quot;&quot; ]]; then</span></span>
<span class="line"><span>       err=$(expr $err + 1)</span></span>
<span class="line"><span>       sleep 1</span></span>
<span class="line"><span>       continue</span></span>
<span class="line"><span>   else</span></span>
<span class="line"><span>       err=0</span></span>
<span class="line"><span>       break</span></span>
<span class="line"><span>   fi</span></span>
<span class="line"><span>done</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if [[ $err != &quot;0&quot; ]]; then</span></span>
<span class="line"><span>   echo &quot;systemctl stop keepalived&quot;</span></span>
<span class="line"><span>   /usr/bin/systemctl stop keepalived</span></span>
<span class="line"><span>   exit 1</span></span>
<span class="line"><span>else</span></span>
<span class="line"><span>   exit 0</span></span>
<span class="line"><span>fi</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span>chmod +x /etc/keepalived/check_apiserver.sh</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-8-5、启动haproxy和keepalived-每台master启用" tabindex="-1"><a class="header-anchor" href="#_3-8-5、启动haproxy和keepalived-每台master启用"><span>3.8.5、启动haproxy和keepalived[每台master启用]</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>systemctl daemon-reload</span></span>
<span class="line"><span>systemctl enable --now haproxy</span></span>
<span class="line"><span>systemctl enable --now keepalived</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-8-6、测试haproxy与keepalived是否正常" tabindex="-1"><a class="header-anchor" href="#_3-8-6、测试haproxy与keepalived是否正常"><span>3.8.6、测试haproxy与keepalived是否正常</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>重要：如果安装了keepalived和haproxy，需要测试keepalived是否是正常的</span></span>
<span class="line"><span>所以这里需要测试VIP是否通</span></span>
<span class="line"><span>root@k8s-master01[18:19:31]:~$ ping 192.168.3.100 -c 4</span></span>
<span class="line"><span>PING 192.168.3.100 (192.168.3.100) 56(84) bytes of data.</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=1 ttl=64 time=0.421 ms</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=2 ttl=64 time=0.289 ms</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=3 ttl=64 time=0.321 ms</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=4 ttl=64 time=0.232 ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--- 192.168.3.100 ping statistics ---</span></span>
<span class="line"><span>4 packets transmitted, 4 received, 0% packet loss, time 3080ms</span></span>
<span class="line"><span>rtt min/avg/max/mdev = 0.232/0.315/0.421/0.071 ms</span></span>
<span class="line"><span>You have new mail in /var/spool/mail/root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>root@k8s-master02[17:52:24]:~$ ping 192.168.3.100 -c 4</span></span>
<span class="line"><span>PING 192.168.3.100 (192.168.3.100) 56(84) bytes of data.</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=1 ttl=64 time=0.458 ms</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=2 ttl=64 time=0.344 ms</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=3 ttl=64 time=0.253 ms</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=4 ttl=64 time=0.373 ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--- 192.168.3.100 ping statistics ---</span></span>
<span class="line"><span>4 packets transmitted, 4 received, 0% packet loss, time 3093ms</span></span>
<span class="line"><span>rtt min/avg/max/mdev = 0.253/0.357/0.458/0.073 ms</span></span>
<span class="line"><span>You have new mail in /var/spool/mail/root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>root@k8s-master03[17:52:24]:~$ ping 192.168.3.100 -c 4</span></span>
<span class="line"><span>PING 192.168.3.100 (192.168.3.100) 56(84) bytes of data.</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=1 ttl=64 time=0.079 ms</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=2 ttl=64 time=0.054 ms</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=3 ttl=64 time=0.058 ms</span></span>
<span class="line"><span>64 bytes from 192.168.3.100: icmp_seq=4 ttl=64 time=0.055 ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--- 192.168.3.100 ping statistics ---</span></span>
<span class="line"><span>4 packets transmitted, 4 received, 0% packet loss, time 3094ms</span></span>
<span class="line"><span>rtt min/avg/max/mdev = 0.054/0.061/0.079/0.012 ms</span></span>
<span class="line"><span>You have new mail in /var/spool/mail/root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>注意： 如果ping不通且telnet没有出现 ] ，则认为VIP不可以，不可在继续往下执行，需要排查keepalived的问题，比如防火墙和selinux，haproxy和keepalived的状态，监听端口等</span></span>
<span class="line"><span>所有节点查看防火墙状态必须为disable和inactive：systemctl status firewalld</span></span>
<span class="line"><span>所有节点查看selinux状态，必须为disable：getenforce</span></span>
<span class="line"><span>master节点查看haproxy和keepalived状态：systemctl status keepalived haproxy</span></span>
<span class="line"><span>master节点查看监听端口：netstat -lntp</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>排查思路：</span></span>
<span class="line"><span>keepalived的问题，比如防火墙和selinux，haproxy和keepalived的状态，监听端口等</span></span>
<span class="line"><span>所有节点查看防火墙状态必须为disable和inactive：systemctl status firewalld</span></span>
<span class="line"><span>所有节点查看selinux状态，必须为disable：getenforce</span></span>
<span class="line"><span>master节点查看haproxy和keepalived状态：systemctl status keepalived haproxy</span></span>
<span class="line"><span>master节点查看监听端口：netstat -lntp</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4、kubernetes集群初始化" tabindex="-1"><a class="header-anchor" href="#_4、kubernetes集群初始化"><span>4、kubernetes集群初始化</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>Master01节点创建 kubeadm-config.yaml 配置文件如下：</span></span>
<span class="line"><span>Master01：（# 注意，如果不是高可用集群，192.168.3.100:16443改为master01的地址，16443改为apiserver的端口，默认是6443，注意更改v1.18.5自己服务器kubeadm的版本：kubeadm version）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#查看办法：</span></span>
<span class="line"><span>kubectl version</span></span>
<span class="line"><span>root@k8s-master01[18:25:48]:~$ kubectl version </span></span>
<span class="line"><span>Client Version: version.Info{Major:&quot;1&quot;, Minor:&quot;21&quot;, GitVersion:&quot;v1.21.0&quot;, GitCommit:&quot;cb303e613a121a29364f75cc67d3d580833a7479&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2021-04-08T16:31:21Z&quot;, GoVersion:&quot;go1.16.1&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;} </span></span>
<span class="line"><span></span></span>
<span class="line"><span>因为安装的版本是 GitVersion:&quot;v1.21.0&quot;</span></span>
<span class="line"><span>下面的yaml文件中的对应版本需要改为  v1.21.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>root@k8s-master01[18:28:03]:~$ cat kubeadm-config.yaml </span></span>
<span class="line"><span>apiVersion: kubeadm.k8s.io/v1beta2</span></span>
<span class="line"><span>bootstrapTokens:</span></span>
<span class="line"><span>- groups:</span></span>
<span class="line"><span>  - system:bootstrappers:kubeadm:default-node-token</span></span>
<span class="line"><span>  token: 7t2weq.bjbawausm0jaxury</span></span>
<span class="line"><span>  ttl: 24h0m0s</span></span>
<span class="line"><span>  usages:</span></span>
<span class="line"><span>  - signing</span></span>
<span class="line"><span>  - authentication</span></span>
<span class="line"><span>kind: InitConfiguration</span></span>
<span class="line"><span>localAPIEndpoint:</span></span>
<span class="line"><span>  advertiseAddress: 192.168.3.31</span></span>
<span class="line"><span>  bindPort: 6443</span></span>
<span class="line"><span>nodeRegistration:</span></span>
<span class="line"><span>  criSocket: /var/run/dockershim.sock</span></span>
<span class="line"><span>  name: k8s-master01</span></span>
<span class="line"><span>  taints:</span></span>
<span class="line"><span>  - effect: NoSchedule</span></span>
<span class="line"><span>    key: node-role.kubernetes.io/master</span></span>
<span class="line"><span>---</span></span>
<span class="line"><span>apiServer:</span></span>
<span class="line"><span>  certSANs:</span></span>
<span class="line"><span>  - 192.168.3.100</span></span>
<span class="line"><span>  timeoutForControlPlane: 4m0s</span></span>
<span class="line"><span>apiVersion: kubeadm.k8s.io/v1beta2</span></span>
<span class="line"><span>certificatesDir: /etc/kubernetes/pki</span></span>
<span class="line"><span>clusterName: kubernetes</span></span>
<span class="line"><span>controlPlaneEndpoint: 192.168.3.100:16443</span></span>
<span class="line"><span>controllerManager: {}</span></span>
<span class="line"><span>dns:</span></span>
<span class="line"><span>  type: CoreDNS</span></span>
<span class="line"><span>etcd:</span></span>
<span class="line"><span>  local:</span></span>
<span class="line"><span>    dataDir: /var/lib/etcd</span></span>
<span class="line"><span>imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span></span>
<span class="line"><span>kind: ClusterConfiguration</span></span>
<span class="line"><span>kubernetesVersion: v1.21.0</span></span>
<span class="line"><span>networking:</span></span>
<span class="line"><span>  dnsDomain: cluster.local</span></span>
<span class="line"><span>  podSubnet: 10.244.0.0/16</span></span>
<span class="line"><span>  serviceSubnet: 10.96.0.0/12</span></span>
<span class="line"><span>scheduler: {}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#更新kubeadm文件: kubeadm-config.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>kubeadm config migrate --old-config kubeadm-config.yaml --new-config new.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#将new.yaml文件复制到其他master节点，之后所有Master节点提前下载镜像，可以节省初始化时间：</span></span>
<span class="line"><span>for i in k8s-master02 k8s-master03; do scp new.yaml $i:/root/; done</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#在其他master节点提前下载镜像，用于解决初始化时间</span></span>
<span class="line"><span>kubeadm config images pull --config /root/new.yaml</span></span>
<span class="line"><span>systemctl enable --now kubelet</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#执行kubeadm config images pull --config /root/new.yaml如果出现如下报错</span></span>
<span class="line"><span>[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.4.1 </span></span>
<span class="line"><span>[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.13-0 </span></span>
<span class="line"><span>failed to pull image &quot;registry.cn-hangzhou.aliyuncs.com/google_containers/coredns/coredns:v1.8.0&quot;: output: Error response from daemon: manifest for registry.cn-hangzhou.aliyuncs.com/google_containers/coredns/coredns:v1.8.0 not found: manifest unknown: manifest unknown </span></span>
<span class="line"><span>, error: exit status 1 </span></span>
<span class="line"><span>To see the stack trace of this error execute with --v=5 or higher </span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#coredns如果没有成功</span></span>
<span class="line"><span>出现ImagePullBackOff：</span></span>
<span class="line"><span>coredns-57d4cbf879-gnh6j        0/1     ImagePullBackOff   0          6m </span></span>
<span class="line"><span>coredns-57d4cbf879-z79bt        0/1     ImagePullBackOff   0          6m</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#请所有节点执行，用于下载镜像即可：</span></span>
<span class="line"><span>docker pull registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0</span></span>
<span class="line"><span>docker tag registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0 registry.cn-hangzhou.aliyuncs.com/google_containers/coredns/coredns:v1.8.0</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#再次查看就会自动拉起</span></span>
<span class="line"><span>coredns-57d4cbf879-gnh6j                  1/1     Running   0          16h </span></span>
<span class="line"><span>coredns-57d4cbf879-z79bt                  1/1     Running   0          16h</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2、-master01初始化" tabindex="-1"><a class="header-anchor" href="#_4-2、-master01初始化"><span>4.2、 master01初始化</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#master01节点执行初始化：</span></span>
<span class="line"><span>kubeadm init --config /root/new.yaml --upload-certs</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#如果初始化失败，重置后再次初始化，命令如下：</span></span>
<span class="line"><span>kubeadm reset -f ; ipvsadm --clear ; rm -rf ~/.kube</span></span>
<span class="line"><span></span></span>
<span class="line"><span>关键提示信息：</span></span>
<span class="line"><span>You should now deploy a pod network to the cluster. </span></span>
<span class="line"><span>Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at: </span></span>
<span class="line"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/ </span></span>
<span class="line"><span> </span></span>
<span class="line"><span>You can now join any number of the control-plane node running the following command on each as root: </span></span>
<span class="line"><span> </span></span>
<span class="line"><span> [其他master加入集群]</span></span>
<span class="line"><span>  kubeadm join 192.168.3.100:16443 --token 7t2weq.bjbawausm0jaxury \ </span></span>
<span class="line"><span>        --discovery-token-ca-cert-hash sha256:aeb438bb077768d6626fbc5f2ff61a903bfea24c2eaaa3fde49bace433176384 \ </span></span>
<span class="line"><span>        --control-plane --certificate-key 530a5f56ce32e4ab69b384f41e6165327e23577f4924558b36efb6bb08a883e5 </span></span>
<span class="line"><span> </span></span>
<span class="line"><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret! </span></span>
<span class="line"><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use </span></span>
<span class="line"><span>&quot;kubeadm init phase upload-certs --upload-certs&quot; to reload certs afterward. </span></span>
<span class="line"><span> </span></span>
<span class="line"><span>Then you can join any number of worker nodes by running the following on each as root: </span></span>
<span class="line"><span></span></span>
<span class="line"><span>[其他node加入集群]</span></span>
<span class="line"><span>kubeadm join 192.168.3.100:16443 --token 7t2weq.bjbawausm0jaxury \ </span></span>
<span class="line"><span>        --discovery-token-ca-cert-hash sha256:aeb438bb077768d6626fbc5f2ff61a903bfea24c2eaaa3fde49bace433176384  </span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#优化</span></span>
<span class="line"><span>mkdir -p $HOME/.kube </span></span>
<span class="line"><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config </span></span>
<span class="line"><span>sudo chown $(id -u):$(id -g) $HOME/.kube/config </span></span>
<span class="line"><span>cat &lt;&lt;EOF &gt;&gt; /root/.bashrc</span></span>
<span class="line"><span>export KUBECONFIG=/etc/kubernetes/admin.conf</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span>source /root/.bashrc</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2、master02-master03-加入master集群" tabindex="-1"><a class="header-anchor" href="#_4-2、master02-master03-加入master集群"><span>4.2、master02 master03 加入master集群</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#Token过期后生成新的token：</span></span>
<span class="line"><span>kubeadm token create --print-join-command</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#Master需要生成-certificate-key</span></span>
<span class="line"><span>root@k8s-master01[15:36:45]:~$ kubeadm init phase upload-certs --upload-certs </span></span>
<span class="line"><span>[upload-certs] Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace </span></span>
<span class="line"><span>[upload-certs] Using certificate key: </span></span>
<span class="line"><span>9b5153fe13fe5a9286eb68fae35311f7357b854a2f8ad925bc7e45b16d2b886e </span></span>
<span class="line"><span></span></span>
<span class="line"><span>#其他master加入集群</span></span>
<span class="line"><span>kubeadm join 192.168.3.100:16443 --token fgtxr1.bz6dw1tci1kbj977    --discovery-token-ca-cert-hash sha256:06ebf46458a41922ff1f5b3bc49365cf3dd938f1a7e3e4a8c8049b5ec5a3aaa5 \</span></span>
<span class="line"><span>   --control-plane --certificate-key 9b5153fe13fe5a9286eb68fae35311f7357b854a2f8ad925bc7e45b16d2b886e</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3、worker01-worker02-worker03-加入master集群" tabindex="-1"><a class="header-anchor" href="#_4-3、worker01-worker02-worker03-加入master集群"><span>4.3、worker01 worker02 worker03 加入master集群</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubeadm join 192.168.1.160:16443 --token 7t2weq.bjbawausm0jaxury --discovery-token-ca-cert-hash sha256:aeb438bb077768d6626fbc5f2ff61a903bfea24c2eaaa3fde49bace433176384</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#过程</span></span>
<span class="line"><span>root@k8s-work01[15:29:45]:~$ kubeadm join 192.168.3.100:16443 --token 7t2weq.bjbawausm0jaxury \ </span></span>
<span class="line"><span>&gt; --discovery-token-ca-cert-hash sha256:aeb438bb077768d6626fbc5f2ff61a903bfea24c2eaaa3fde49bace433176384 </span></span>
<span class="line"><span>[preflight] Running pre-flight checks </span></span>
<span class="line"><span>[preflight] Reading configuration from the cluster... </span></span>
<span class="line"><span>[preflight] FYI: You can look at this config file with &#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39; </span></span>
<span class="line"><span>[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot; </span></span>
<span class="line"><span>[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot; </span></span>
<span class="line"><span>[kubelet-start] Starting the kubelet </span></span>
<span class="line"><span>[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap... </span></span>
<span class="line"><span> </span></span>
<span class="line"><span>This node has joined the cluster: </span></span>
<span class="line"><span>* Certificate signing request was sent to apiserver and a response was received. </span></span>
<span class="line"><span>* The Kubelet was informed of the new secure connection details. </span></span>
<span class="line"><span> </span></span>
<span class="line"><span>Run &#39;kubectl get nodes&#39; on the control-plane to see this node join the cluster.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4、加入结果预览" tabindex="-1"><a class="header-anchor" href="#_4-4、加入结果预览"><span>4.4、加入结果预览</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>root@k8s-master01[16:06:10]:~$ kubectl get nodes </span></span>
<span class="line"><span>NAME           STATUS     ROLES                  AGE     VERSION </span></span>
<span class="line"><span>k8s-master01   NotReady   control-plane,master   6m15s   v1.21.0 </span></span>
<span class="line"><span>k8s-master02   NotReady   control-plane,master   5m23s   v1.21.0 </span></span>
<span class="line"><span>k8s-master03   NotReady   control-plane,master   4m21s   v1.21.0 </span></span>
<span class="line"><span>k8s-worker01     NotReady   &lt;none&gt;                 11s     v1.21.0 </span></span>
<span class="line"><span>k8s-worker02     NotReady   &lt;none&gt;                 0s      v1.21.0</span></span>
<span class="line"><span>k8s-worker03     NotReady   &lt;none&gt;                 0s      v1.21.0</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>采用初始化安装方式，所有的系统组件均以容器的方式运行并且在kube-system命名空间内，此时可以查看Pod状态：</span></span>
<span class="line"><span>root@k8s-master01[20:18:57]:~$ kubectl get pod -n kube-system </span></span>
<span class="line"><span>NAME                                   READY   STATUS    RESTARTS   AGE </span></span>
<span class="line"><span>coredns-57d4cbf879-8vs6c               0/1     Pending   0          75m </span></span>
<span class="line"><span>coredns-57d4cbf879-p99nc               0/1     Pending   0          75m </span></span>
<span class="line"><span>etcd-k8s-master01                      1/1     Running   0          75m </span></span>
<span class="line"><span>etcd-k8s-master02                      1/1     Running   0          4m45s </span></span>
<span class="line"><span>etcd-k8s-master03                      1/1     Running   0          4m23s </span></span>
<span class="line"><span>kube-apiserver-k8s-master01            1/1     Running   0          75m </span></span>
<span class="line"><span>kube-apiserver-k8s-master02            1/1     Running   0          4m45s </span></span>
<span class="line"><span>kube-apiserver-k8s-master03            1/1     Running   0          4m10s </span></span>
<span class="line"><span>kube-controller-manager-k8s-master01   1/1     Running   1          75m </span></span>
<span class="line"><span>kube-controller-manager-k8s-master02   1/1     Running   0          4m45s </span></span>
<span class="line"><span>kube-controller-manager-k8s-master03   1/1     Running   0          4m21s </span></span>
<span class="line"><span>kube-proxy-2zc6p                       1/1     Running   0          4m46s </span></span>
<span class="line"><span>kube-proxy-djtbn                       1/1     Running   0          3m30s </span></span>
<span class="line"><span>kube-proxy-g2ddr                       1/1     Running   0          75m </span></span>
<span class="line"><span>kube-proxy-gf7w8                       1/1     Running   0          3m34s </span></span>
<span class="line"><span>kube-proxy-mfsbz                       1/1     Running   0          3m59s </span></span>
<span class="line"><span>kube-scheduler-k8s-master01            1/1     Running   1          75m </span></span>
<span class="line"><span>kube-scheduler-k8s-master02            1/1     Running   0          4m45s </span></span>
<span class="line"><span>kube-scheduler-k8s-master03            1/1     Running   0          4m19s </span></span>
<span class="line"><span></span></span>
<span class="line"><span>#出现 coredns Pending状态，原因是因为没有网络</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5、master01节点配置环境变量-用于访问kubernetes集群" tabindex="-1"><a class="header-anchor" href="#_4-5、master01节点配置环境变量-用于访问kubernetes集群"><span>4.5、Master01节点配置环境变量，用于访问Kubernetes集群：</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>cat &lt;&lt;EOF &gt;&gt; /root/.bashrc</span></span>
<span class="line"><span>export KUBECONFIG=/etc/kubernetes/admin.conf</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span>source /root/.bashrc</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5、安装calico网络组件-master01操作" tabindex="-1"><a class="header-anchor" href="#_5、安装calico网络组件-master01操作"><span>5、安装calico网络组件[master01操作]</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#运行calicon文件，无需配置改变，直接运行</span></span>
<span class="line"><span>kubectl create -f https://docs.projectcalico.org/archive/v3.21/manifests/tigera-operator.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#不建议直接使用需要修改，符合kubernetes集群环境才行，因此先下载到本地</span></span>
<span class="line"><span>#kubectl create -f https://docs.projectcalico.org/archive/v3.21/manifests/custom-resources.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mkdir calicodir</span></span>
<span class="line"><span>cd calicodir</span></span>
<span class="line"><span>wget https://docs.projectcalico.org/archive/v3.21/manifests/custom-resources.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#需要修改的地方如下：</span></span>
<span class="line"><span>[root@master01 calicodir]# cat custom-resources.yaml </span></span>
<span class="line"><span># This section includes base Calico installation configuration.</span></span>
<span class="line"><span># For more information, see: https://docs.projectcalico.org/v3.21/reference/installation/api#operator.tigera.io/v1.Installation</span></span>
<span class="line"><span>apiVersion: operator.tigera.io/v1</span></span>
<span class="line"><span>kind: Installation</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: default</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  # Configures Calico networking.</span></span>
<span class="line"><span>  calicoNetwork:</span></span>
<span class="line"><span>    # Note: The ipPools section cannot be modified post-install.</span></span>
<span class="line"><span>    ipPools:</span></span>
<span class="line"><span>    - blockSize: 26</span></span>
<span class="line"><span>      cidr: 10.244.0.0/16      -----&gt;这个地方需要做修改</span></span>
<span class="line"><span>      encapsulation: VXLANCrossSubnet</span></span>
<span class="line"><span>      natOutgoing: Enabled</span></span>
<span class="line"><span>      nodeSelector: all()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>---</span></span>
<span class="line"><span></span></span>
<span class="line"><span># This section configures the Calico API server.</span></span>
<span class="line"><span># For more information, see: https://docs.projectcalico.org/v3.21/reference/installation/api#operator.tigera.io/v1.APIServer</span></span>
<span class="line"><span>apiVersion: operator.tigera.io/v1</span></span>
<span class="line"><span>kind: APIServer </span></span>
<span class="line"><span>metadata: </span></span>
<span class="line"><span>  name: default </span></span>
<span class="line"><span>spec: {}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#接着对该资源清单文件进行使用</span></span>
<span class="line"><span>[root@master01 calicodir]# kubectl apply -f custom-resources.yaml </span></span>
<span class="line"><span>installation.operator.tigera.io/default created</span></span>
<span class="line"><span>apiserver.operator.tigera.io/default created</span></span>
<span class="line"><span></span></span>
<span class="line"><span>##使用如下命令进行查看</span></span>
<span class="line"><span>[root@master01 calicodir]# kubectl get ns</span></span>
<span class="line"><span>NAME              STATUS   AGE</span></span>
<span class="line"><span>calico-system     Active   48s       ##创建了一个命名空间</span></span>
<span class="line"><span>default           Active   71m</span></span>
<span class="line"><span>kube-node-lease   Active   71m</span></span>
<span class="line"><span>kube-public       Active   71m</span></span>
<span class="line"><span>kube-system       Active   71m</span></span>
<span class="line"><span>tigera-operator   Active   4m59s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>##我们可以查看calico-system命名空间下有哪些pod，运行时间比较长</span></span>
<span class="line"><span></span></span>
<span class="line"><span>##官方建议直接使用watch命令查看，直到他全部运行为止</span></span>
<span class="line"><span>watch kubectl get pods -n calico-system</span></span>
<span class="line"><span>##我们发现特别慢，原因是因为kubernetes的master节点不允许做工作负载调度，因此需要一个操作，取消污点，命令如下：</span></span>
<span class="line"><span>kubectl taint nodes --all node-role.kubernetes.io/master-</span></span>
<span class="line"><span></span></span>
<span class="line"><span>##接着我们再次查看，等待直到完成，这个过程巨慢</span></span>
<span class="line"><span>watch kubectl get pods -n calico-system</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#最后查看容器和节点状态:</span></span>
<span class="line"><span>root@k8s-master01[18:34:00]:~$ kubectl get pod -n kube-system</span></span>
<span class="line"><span>NAME                                   READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>coredns-6f6b8cc4f6-dd2kf               1/1     Running   0          4h4m</span></span>
<span class="line"><span>coredns-6f6b8cc4f6-f9gw8               1/1     Running   0          4h4m</span></span>
<span class="line"><span>etcd-k8s-master01                      1/1     Running   5          4h4m</span></span>
<span class="line"><span>etcd-k8s-master02                      1/1     Running   0          4h4m</span></span>
<span class="line"><span>etcd-k8s-master03                      1/1     Running   0          4h4m</span></span>
<span class="line"><span>kube-apiserver-k8s-master01            1/1     Running   0          4h4m</span></span>
<span class="line"><span>kube-apiserver-k8s-master02            1/1     Running   0          4h4m</span></span>
<span class="line"><span>kube-apiserver-k8s-master03            1/1     Running   0          4h4m</span></span>
<span class="line"><span>kube-controller-manager-k8s-master01   1/1     Running   1          4h4m</span></span>
<span class="line"><span>kube-controller-manager-k8s-master02   1/1     Running   0          4h4m</span></span>
<span class="line"><span>kube-controller-manager-k8s-master03   1/1     Running   0          4h4m</span></span>
<span class="line"><span>kube-proxy-8fpmv                       1/1     Running   0          4h3m</span></span>
<span class="line"><span>kube-proxy-8sw6v                       1/1     Running   0          4h3m</span></span>
<span class="line"><span>kube-proxy-9chjn                       1/1     Running   0          4h3m</span></span>
<span class="line"><span>kube-proxy-ctrth                       1/1     Running   0          4h4m</span></span>
<span class="line"><span>kube-proxy-gsst4                       1/1     Running   0          4h4m</span></span>
<span class="line"><span>kube-proxy-qb9kh                       1/1     Running   0          4h3m</span></span>
<span class="line"><span>kube-scheduler-k8s-master01            1/1     Running   13         4h4m</span></span>
<span class="line"><span>kube-scheduler-k8s-master02            1/1     Running   4          4h4m</span></span>
<span class="line"><span>kube-scheduler-k8s-master03            1/1     Running   4          4h4m</span></span>
<span class="line"><span>You have new mail in /var/spool/mail/root</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6、安装dashboard" tabindex="-1"><a class="header-anchor" href="#_6、安装dashboard"><span>6、安装dashboard</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#1. 安装老版本</span></span>
<span class="line"><span>cd /root/k8s-ha-install/dashboard/</span></span>
<span class="line"><span>kubectl create -f .</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#2. 安装最新版：</span></span>
<span class="line"><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#授权：</span></span>
<span class="line"><span>vim admin.yaml</span></span>
<span class="line"><span>#--------------------------admin.yaml--------------------------#</span></span>
<span class="line"><span>apiVersion: v1 </span></span>
<span class="line"><span>kind: ServiceAccount </span></span>
<span class="line"><span>metadata: </span></span>
<span class="line"><span>  name: admin-user </span></span>
<span class="line"><span>  namespace: kube-system </span></span>
<span class="line"><span>--- </span></span>
<span class="line"><span>apiVersion: rbac.authorization.k8s.io/v1 </span></span>
<span class="line"><span>kind: ClusterRoleBinding </span></span>
<span class="line"><span>metadata: </span></span>
<span class="line"><span>  name: admin-user </span></span>
<span class="line"><span>  annotations: </span></span>
<span class="line"><span>    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot; </span></span>
<span class="line"><span>roleRef: </span></span>
<span class="line"><span>  apiGroup: rbac.authorization.k8s.io </span></span>
<span class="line"><span>  kind: ClusterRole </span></span>
<span class="line"><span>  name: cluster-admin </span></span>
<span class="line"><span>subjects: </span></span>
<span class="line"><span>- kind: ServiceAccount </span></span>
<span class="line"><span>  name: admin-user </span></span>
<span class="line"><span>  namespace: kube-system</span></span>
<span class="line"><span>#--------------------------admin.yaml--------------------------#</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#执行安装</span></span>
<span class="line"><span>kubectl apply -f admin.yaml -n kube-system</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>登录dashboard</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>在谷歌浏览器（Chrome）启动文件中加入启动参数，用于解决无法访问Dashboard的问题，参考图1-1：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>谷歌浏览器添加参数：</span></span>
<span class="line"><span>--test-type --ignore-certificate-errors</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/vuepress/assets/2024-01-18_100251_7822250.19618477323547356-YaLPLebj.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>更改dashboard的svc为NodePort：</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>spec: </span></span>
<span class="line"><span>  clusterIP: 10.108.157.21 </span></span>
<span class="line"><span>  clusterIPs: </span></span>
<span class="line"><span>  - 10.108.157.21 </span></span>
<span class="line"><span>  externalTrafficPolicy: Cluster </span></span>
<span class="line"><span>  ports: </span></span>
<span class="line"><span>  - nodePort: 30195 </span></span>
<span class="line"><span>    port: 443 </span></span>
<span class="line"><span>    protocol: TCP </span></span>
<span class="line"><span>    targetPort: 8443 </span></span>
<span class="line"><span>  selector: </span></span>
<span class="line"><span>    k8s-app: kubernetes-dashboard </span></span>
<span class="line"><span>  sessionAffinity: None </span></span>
<span class="line"><span>  type: ClusterIP     #改为 NodePort </span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>#修改完成后如下：</span></span>
<span class="line"><span>spec: </span></span>
<span class="line"><span>  clusterIP: 10.108.157.21 </span></span>
<span class="line"><span>  clusterIPs: </span></span>
<span class="line"><span>  - 10.108.157.21 </span></span>
<span class="line"><span>  externalTrafficPolicy: Cluster </span></span>
<span class="line"><span>  ports: </span></span>
<span class="line"><span>  - nodePort: 30195 </span></span>
<span class="line"><span>    port: 443 </span></span>
<span class="line"><span>    protocol: TCP </span></span>
<span class="line"><span>    targetPort: 8443 </span></span>
<span class="line"><span>  selector: </span></span>
<span class="line"><span>    k8s-app: kubernetes-dashboard </span></span>
<span class="line"><span>  sessionAffinity: None </span></span>
<span class="line"><span>  type: NodePort      #已经改为NodePort</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>修改完成后访问dashboard：</span></span>
<span class="line"><span>#查看端口号：</span></span>
<span class="line"><span>kubectl get svc kubernetes-dashboard -n kubernetes-dashboard</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7、通过https协议进行访问" tabindex="-1"><a class="header-anchor" href="#_7、通过https协议进行访问"><span>7、通过https协议进行访问</span></a></h2><p><code>https://192.168.3.31:30995/</code><img src="/vuepress/assets/2024-01-18_100447_8443210.19085411082207815-BYQJrZlP.png" alt="" loading="lazy"></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#查看token值：</span></span>
<span class="line"><span>kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk &#39;{print $1}&#39;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#得到 token:</span></span>
<span class="line"><span>eyJhbGciOiJSUzI1NiIsImtpZCI6IlFkM3BUd0xxVEZ6a0t4Njl2QnVaMWhLNUl4NFlzUkVrQngzbmlQeG4zczgifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXRidjRkIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI0MzI2NDM1My1iNzY4LTRlNTEtYjljZS0wY2FlMzJlNThmOTgiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.jKtz39e-9EBlLhIW571Ms63ywad2z0s2hEa0ZalBRcEDXDKLN7jDejTLrrcyeNY5pRa8AUtbS1ckiYWI7OOlR3PBjD5Tgaz2HEKFw0FEoNMQnU8uLzR5WbUX4obOpzAyB4WYmCS9vK-ud98mmMHOT15Ee2BeaxIWTBL715m-NJcIxxByvsBtogVj7zWJayAVLOspMLps8hWk8XJDXpWEx0J8uU9KUPOey3YMiO5gNlk5TRHcZJOGg_7HV8_55MqKTQ8K9Jhsu5uVieB3kuJdwJdcGCGrMi1UVGx-RgJwGbZqMkXgy55QAp2he_sNFZmThhuxvz7FIclUyyoUZ43V9Q</span></span>
<span class="line"><span></span></span>
<span class="line"><span>将token粘贴到web页面上的token输入栏</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/vuepress/assets/2024-01-18_100630_8176320.023882901635084886-DefU2e33.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_8、-配置修改" tabindex="-1"><a class="header-anchor" href="#_8、-配置修改"><span>8、 配置修改</span></a></h2><blockquote><p>将Kube-proxy改为ipvs模式，因为在初始化集群的时候注释了ipvs配置，所以需要自行修改一下： 在master01节点执行</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl edit cm kube-proxy -n kube-system</span></span>
<span class="line"><span>mode： 修改为 mode: ipvs</span></span>
<span class="line"><span></span></span>
<span class="line"><span>更新Kube-Proxy的Pod：</span></span>
<span class="line"><span>kubectl patch daemonset kube-proxy -p &quot;{\&quot;spec\&quot;:{\&quot;template\&quot;:{\&quot;metadata\&quot;:{\&quot;annotations\&quot;:{\&quot;date\&quot;:\&quot;`date +&#39;%s&#39;`\&quot;}}}}}&quot; -n kube-system</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>验证Kube-Proxy模式：</span></span>
<span class="line"><span>curl 127.0.0.1:10249/proxyMode</span></span>
<span class="line"><span>ipvs</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>最后集群状态</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>root@k8s-master01[10:36:14]:~$ kubectl get nodes</span></span>
<span class="line"><span>NAME           STATUS   ROLES                  AGE   VERSION</span></span>
<span class="line"><span>k8s-master01   Ready    control-plane,master   19h   v1.21.14</span></span>
<span class="line"><span>k8s-master02   Ready    control-plane,master   19h   v1.21.14</span></span>
<span class="line"><span>k8s-master03   Ready    control-plane,master   19h   v1.21.14</span></span>
<span class="line"><span>k8s-worker01   Ready    &lt;none&gt;                 19h   v1.21.14</span></span>
<span class="line"><span>k8s-worker02   Ready    &lt;none&gt;                 19h   v1.21.14</span></span>
<span class="line"><span>k8s-worker03   Ready    &lt;none&gt;                 19h   v1.21.14</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9、-高可用测试" tabindex="-1"><a class="header-anchor" href="#_9、-高可用测试"><span>9、 高可用测试</span></a></h2><p><code>k8s-master01是vip地址，停止eth0后vip消失，vip地址会漂移到k8s-master01上</code></p><h2 id="_10、-安装kuboard集群管理面板" tabindex="-1"><a class="header-anchor" href="#_10、-安装kuboard集群管理面板"><span>10、 安装Kuboard集群管理面板</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#在master01节点上执行</span></span>
<span class="line"><span>kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml</span></span>
<span class="line"><span># 您也可以使用下面的指令，唯一的区别是，该指令使用华为云的镜像仓库替代 docker hub 分发 Kuboard 所需要的镜像</span></span>
<span class="line"><span># kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3-swr.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#执行指令 watch kubectl get pods -n kuboard，等待 kuboard 名称空间中所有的 Pod 就绪，如下所示，</span></span>
<span class="line"><span>Every 2.0s: kubectl get pods -n kuboard                          Thu Jan 18 14:20:40 2024</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAME                          READY   STATUS              RESTARTS   AGE</span></span>
<span class="line"><span>kuboard-etcd-ltkjt            1/1     Running             0          3m54s</span></span>
<span class="line"><span>kuboard-etcd-m257r            0/1     ContainerCreating   0          3m54s</span></span>
<span class="line"><span>kuboard-etcd-q6dqw            1/1     Running             0          3m54s</span></span>
<span class="line"><span>kuboard-v3-5fc46b5557-qq6pk   0/1     ContainerCreating   0          3m53s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#最终完成后的状态</span></span>
<span class="line"><span>Every 2.0s: kubectl get pods -n kuboard                          Thu Jan 18 14:26:54 2024</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAME                               READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>kuboard-agent-2-78b6856bb5-kw67d   1/1     Running   1          3m58s</span></span>
<span class="line"><span>kuboard-agent-857d7b8f45-dmctj     1/1     Running   1          3m58s</span></span>
<span class="line"><span>kuboard-etcd-ltkjt                 1/1     Running   0          10m</span></span>
<span class="line"><span>kuboard-etcd-m257r                 1/1     Running   0          10m</span></span>
<span class="line"><span>kuboard-etcd-q6dqw                 1/1     Running   0          10m</span></span>
<span class="line"><span>kuboard-questdb-586fb449fc-hdvwp   1/1     Running   0          3m58s</span></span>
<span class="line"><span>kuboard-v3-5fc46b5557-qq6pk        1/1     Running   0          10m</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>访问 Kuboard</strong></p><blockquote><p>在浏览器中打开链接 http://your-node-ip-address:30080 输入初始用户名和密码，并登录 用户名： admin 密码： Kuboard123 浏览器兼容性 请使用 Chrome / FireFox / Safari / Edge 等浏览器 不兼容 IE 以及以 IE 为内核的浏览器 添加新的集群 Kuboard v3 是支持 Kubernetes 多集群管理的，在 Kuboard v3 的首页里，点击 添加集群 按钮，在向导的引导下可以完成集群的添加； 向 Kuboard v3 添加新的 Kubernetes 集群时，请确保： 您新添加集群可以访问到当前集群 Master 节点 内网IP 的 30080 TCP、30081 TCP、30081 UDP 端口； 如果您打算新添加到 Kuboard 中的集群与当前集群不在同一个局域网，请咨询 Kuboard 团队，帮助您解决问题。</p></blockquote><figure><img src="/vuepress/assets/2024-01-18_142756_3843980.9232590886755949-Dh_lFSbG.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>根据提示添加集群，最后效果如下</strong></p><figure><img src="/vuepress/assets/2024-01-18_144246_4851460.36406800115353777-0yZ9CUiV.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a class="route-link route-link-active auto-link prev" href="/vuepress/note/kubernetes/install/kubeadm/High%20availability/" aria-label="2、安装3主3从"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>2、安装3主3从</div></a><!----></nav><div id="vp-comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if-->  字</div><button type="button" class="wl-btn">登录</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v3.2.6</div></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">一天是IT人，一辈子都是！ © 风华 2024-至今 Mr.FH</div><div class="vp-copyright">Copyright © 2024 风华 </div></footer></div><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/vuepress/assets/app-DuswJAHG.js" defer></script>
  </body>
</html>
